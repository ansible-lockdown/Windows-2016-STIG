---
# THE FOLLOWING 3 CONTROLS WILL FAIL UNLESS THEY ARE IN THE FOLLOWING ORDER FOR CLOUD BASED SYSTEMS
# below task is dependent on WN19-AC-000020 and WN19-AC-000030, maybe custom fail when known error if WN19-AC-000020 not set? "The key 'LockoutDuration' in section 'System Access' is not a valid key, cannot set this value"
- name: "MEDIUM | WN16-AC-000020 | PATCH | Windows Server 2016 must have the number of allowed bad logon attempts configured to three or less."
  block:
      - name: "MEDIUM | WN16-AC-000020 | AUDIT | Windows Server 2016 must have the number of allowed bad logon attempts configured to three or less. | Warning For Bad Variable."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid number of days set for wn16stig_lockoutbadcount please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - wn16stig_lockoutbadcount == 0 or
              wn16stig_lockoutbadcount > 3

      - name: "MEDIUM | WN16-AC-000020 | AUDIT | Windows Server 2016 must have the number of allowed bad logon attempts configured to three or less. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-AC-000020'
        when:
            - wn16stig_lockoutbadcount == 0 or
              wn16stig_lockoutbadcount > 3

      - name: "MEDIUM | WN16-AC-000020 | PATCH | Windows Server 2016 must have the number of allowed bad logon attempts configured to three or less."
        community.windows.win_security_policy:
            section: System Access
            key: LockoutBadCount
            value: "{{ wn16stig_lockoutbadcount }}"
        when:
            - wn16stig_lockoutbadcount > 0
            - wn16stig_lockoutbadcount <= 3
  when:
      - wn16_ac_000020
      - not win16stig_cloud_based_system
  tags:
      - WN16-AC-000020
      - V-224867
      - SV-224867r569186_rule
      - SRG-OS-000021-GPOS-00005
      - CCI-000044
      - CAT2_CLOUD2

# below task is dependent on WN16-AC-000020 and WN16-AC-000030, maybe custom fail when known error if WN16-AC-000020 not set? "The key 'LockoutDuration' in section 'System Access' is not a valid key, cannot set this value"
- name: "MEDIUM | WN16-AC-000010 | PATCH | Windows Server 2016 account lockout duration must be configured to 15 minutes or greater."
  block:
      - name: "MEDIUM | WN16-AC-000010 | PATCH | Windows Server 2016 account lockout duration must be configured to 15 minutes or greater. | Warning For Bad Variable."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid number of minutes set for wn16stig_lockoutduration please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - wn16stig_lockoutduration < 15
            - wn16stig_lockoutduration > 0

      - name: "MEDIUM | WN16-AC-000010 | PATCH | Windows Server 2016 account lockout duration must be configured to 15 minutes or greater. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-AC-000010'
        when:
            - wn16stig_lockoutduration < 15
            - wn16stig_lockoutduration > 0

      - name: "MEDIUM | WN16-AC-000010 | PATCH | Windows Server 2016 account lockout duration must be configured to 15 minutes or greater. | Apply Variable."
        community.windows.win_security_policy:
            section: System Access
            key: LockoutDuration
            value: "{{ wn16stig_lockoutduration }}"
        when:
            - wn16stig_lockoutduration == 0 or
              wn16stig_lockoutduration >= 15
  when:
      - wn16_ac_000010
      - not win16stig_cloud_based_system
  tags:
      - WN16-AC-000010
      - V-205795
      - SRG-OS-000329-GPOS-00128
      - SV-205795r569188_rule
      - CCI-002238
      - CAT2_CLOUD2

# below task is dependent on WN16-AC-000020, maybe custom fail when known error if WN16-AC-000020 not set? "The key 'ResetLockoutCount' in section 'System Access' is not a valid key, cannot set this value"
- name: "MEDIUM | WN16-AC-000030 | PATCH | Windows Server 2016 must have the period of time before the bad logon counter is reset configured to 15 minutes or greater."
  block:
      - name: MEDIUM | WN16-AC-000030 | AUDIT | Windows Server 2016 must have the period of time before the bad logon counter is reset configured to 15 minutes or greater."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid number of days set for wn16stig_resetlockoutcount please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - wn16stig_resetlockoutcount < 15

      - name: MEDIUM | WN16-AC-000030 | AUDIT | Windows Server 2016 must have the period of time before the bad logon counter is reset configured to 15 minutes or greater. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-AC-000030'
        when:
            - wn16stig_resetlockoutcount < 15

      - name: "MEDIUM | WN16-AC-000030 | PATCH | Windows Server 2016 must have the period of time before the bad logon counter is reset configured to 15 minutes or greater. | Apply Variable"
        community.windows.win_security_policy:
            section: System Access
            key: ResetLockoutCount
            value: "{{ wn16stig_resetlockoutcount }}"
        when:
            - wn16stig_resetlockoutcount >= 15
  when:
      - wn16_ac_000030
      - not win16stig_cloud_based_system
  tags:
      - WN16-AC-000030
      - V-224868
      - SV-224868r852302_rule
      - SRG-OS-000021-GPOS-00005
      - CCI-000044
      - CAT2_CLOUD2
