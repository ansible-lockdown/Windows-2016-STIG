---

# we need a variable to the "changed" admin account name since control XXXX states acct must be renamed
# enumerating on DC is different than standalone
# DC == Get-ADUser -Filter * -Properties SID, PasswordLastSet | Where SID -Like "*-500" | Ft Name, SID, PasswordLastSet
- name: "MEDIUM | WN16-00-000030 | AUDIT | Passwords for the built-in Administrator account must be changed at least every 60 days. | Get Accounts On DC"
  block:
      - name: "MEDIUM | WN16-00-000030 | AUDIT - DOMAIN CONTROLLER | Passwords for the built-in Administrator account must be changed at least every 60 days."
        ansible.windows.win_shell: "Get-ADUser -Filter * -Property PasswordLastSet | Where SID -like S-1-5-21-*-500 | Where-Object {$_.PasswordLastSet -lt ((Get-Date).AddDays(-{{ wn16_00_000030_pass_age }}))} | Select Name,PasswordLastSet"
        # win_shell: "Get-ADUser krbtgt -Property PasswordLastSet | Where-Object {$_.PasswordLastSet -lt ((Get-Date).AddDays(-{{ wn16_dc_000430_pass_age }}))} | Select-Object -ExpandProperty PasswordLastSet"
        register: wn16_00_000030_audit_dc
        changed_when: false
        failed_when: false
        when:
            - ansible_windows_domain_role == "Primary domain controller"

      - name: "MEDIUM | WN16-00-000030 | AUDIT - DOMAIN CONTROLLER | Passwords for the built-in Administrator account must be changed at least every 60 days. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! The following account appears to be the default admin account and the password does not meet"
                - "the control specific age of {{ wn16stig_pass_age }}"
                - "{{ wn16_00_000030_audit_dc.stdout.split('\n') }}"
        when:
            - wn16_00_000030_audit_dc is not skipped
            - wn16_00_000030_audit_dc.stdout != ""

      - name: "MEDIUM | WN16-00-000030 | AUDIT - DOMAIN MEMBERS OR STANDALONE | Passwords for the built-in Administrator account must be changed at least every 60 days. | Get Accounts On DM or SA"
        ansible.windows.win_shell: "Get-Localuser -Name * | Select * | Where SID -like S-1-5-21-*-500 | Where-Object {$_.PasswordLastSet -lt ((Get-Date).AddDays(-{{ wn16stig_pass_age }}))} | Select Name,PasswordLastSet"
        changed_when: false
        failed_when: false
        register: wn16_00_000030_audit_dm_sa
        when: not ansible_windows_domain_role == "Primary domain controller"

      - name: "MEDIUM | WN16-00-000030 | AUDIT - DOMAIN MEMBERS OR STANDALONE | Passwords for the built-in Administrator account must be changed at least every 60 days. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! The following account appears to be the default admin account and the password does not meet"
                - "the control specific age of {{ wn16stig_pass_age }}"
                - "{{ wn16_00_000030_audit_dm_sa.stdout.split('\n') }}"
        when:
            - wn16_00_000030_audit_dm_sa is not skipped
            - wn16_00_000030_audit_dm_sa.stdout != ""

      - name: "MEDIUM | WN16-00-000030 | AUDIT | Passwords for the built-in Administrator account must be changed at least every 60 days. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000030'
        when:
            - wn16_00_000030_audit_dc is not skipped and wn16_00_000030_audit_dc.stdout != "" or
              wn16_00_000030_audit_dm_sa is not skipped and wn16_00_000030_audit_dm_sa.stdout != ""
  when:
      - wn16_00_000030
  tags:
      - WN16-00-000030
      - V-224820
      - SV-224820r857224_rule
      - SRG-OS-000076-GPOS-00044
      - CCI-000199
      - CAT2
      - audit
      - NeedToTestDomainController

- name: "MEDIUM | WN16-00-000050 | AUDIT | Members of the Backup Operators group must have separate accounts for backup duties and normal operational tasks."
  block:
      - name: "MEDIUM | WN16-00-000050 | AUDIT - DOMAIN MEMBERS OR STANDALONE | Members of the Backup Operators group must have separate accounts for backup duties and normal operational tasks. | Audit Accounts."
        ansible.windows.win_shell: Get-LocalGroupMember -Name 'Backup Operators'
        changed_when: false
        failed_when: false
        register: wn16_00_000050_audit

      - name: "MEDIUM | WN16-00-000050 | AUDIT - DOMAIN MEMBERS OR STANDALONE | Members of the Backup Operators group must have separate accounts for backup duties and normal operational tasks. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. The accounts listed are members of the Backup Operators group."
                - "Please verify these accounts have separate accounts for backup duties and normal operational tasks."
                - "{{ wn16_00_000050_audit.stdout.split('\n') }}"
        when:
            - wn16_00_000050_audit is not skipped
            - wn16_00_000050_audit.stdout != ""

      - name: "MEDIUM | WN16-00-000050 | AUDIT - DOMAIN MEMBERS OR STANDALONE | Members of the Backup Operators group must have separate accounts for backup duties and normal operational tasks. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000050'
        when:
            - wn16_00_000050_audit is not skipped
            - wn16_00_000050_audit.stdout != ""
  when:
      - wn16_00_000050
      - not ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-00-000050
      - V-224822
      - SV-224822r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-00-000060 | AUDIT | Manually managed application account passwords must be at least 15 characters in length."
  block:
      - name: "MEDIUM | WN16-00-000060 | AUDIT | Manually managed application account passwords must be at least 15 characters in length. | Warning Message"
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2016 Manually managed application account passwords must be at least 15 characters in length."

      - name: "MEDIUM | WN16-00-000060 | AUDIT | Manually managed application account passwords must be at least 15 characters in length. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000060'
  when:
      - wn16_00_000060
  tags:
      - WN16-00-000060
      - V-224823
      - SV-224823r569186_rule
      - SRG-OS-000078-GPOS-00046
      - CCI-000205
      - CAT2

- name: "MEDIUM | WN16-00-000070 | AUDIT | Manually managed application account passwords must be changed at least annually or when a system administrator with knowledge of the password leaves the organization."
  block:
      - name: "MEDIUM | WN16-00-000070 | AUDIT | Manually managed application account passwords must be changed at least annually or when a system administrator with knowledge of the password leaves the organization. | Warning Message"
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2016 manually managed application account passwords must be changed at least annually or when a system administrator with knowledge of the password leaves the organization."

      - name: "MEDIUM | WN16-00-000070 | AUDIT | Manually managed application account passwords must be changed at least annually or when a system administrator with knowledge of the password leaves the organization. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000070'
  when:
      - wn16_00_000070
  tags:
      - WN16-00-000070
      - V-224824
      - SV-224824r857226_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2
      # how to make this list?

- name: "MEDIUM | WN16-00-000080 | AUDIT | Shared user accounts must not be permitted on the system."
  block:
      - name: "MEDIUM | WN16-00-000080 | AUDIT | Shared user accounts must not be permitted on the system. | Warning Message"
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2016 shared user accounts must not be permitted."

      - name: "MEDIUM | WN16-00-000080 | AUDIT | Shared user accounts must not be permitted on the system. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000080'
  when:
      - wn16_00_000080
  tags:
      - WN16-00-000080
      - V-224825
      - SV-224825r569186_rule
      - SRG-OS-000104-GPOS-00051
      - CCI-000764
      - CAT2
      # org has to supply a list? shared acct must be in SSP?

- name: "MEDIUM | WN16-00-000090 | AUDIT | Windows Server 2016 must employ a deny-all, permit-by-exception policy to allow the execution of authorized software programs."
  block:
      - name: "MEDIUM | WN16-00-000090 | AUDIT | Windows Server 2016 must employ a deny-all, permit-by-exception policy to allow the execution of authorized software programs. | Warning Message"
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2019 must employ a deny-all, permit-by-exception policy to allow the execution of authorized software programs."

      - name: "MEDIUM | WN16-00-000090 | AUDIT | Windows Server 2016 must employ a deny-all, permit-by-exception policy to allow the execution of authorized software programs. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000090'
  when:
      - wn16_00_000090
  tags:
      - WN16-00-000090
      - V-224826
      - SV-224826r890501_rule
      - SRG-OS-000370-GPOS-00155
      - CCI-001774
      - CAT2
      # Get-AppLockerPolicy -Effective

- name: "MEDIUM | WN16-00-000100 | AUDIT | Windows Server 2016 domain-joined systems must have a Trusted Platform Module (TPM) enabled and ready for use."
  block:
      - name: "MEDIUM | WN16-00-000100 | AUDIT | Windows Server 2016 domain-joined systems must have a Trusted Platform Module (TPM) enabled and ready for use. | Get TPM Settings"
        ansible.windows.win_command: wmic /namespace:\\root\cimv2\security\microsofttpm path win32_tpm get * /format:textvaluelist.xsl
        changed_when: false
        failed_when: false
        register: wn16_00_000010_tpm_status

      - name: "MEDIUM | WN16-00-000100 | AUDIT | Windows Server 2016 domain-joined systems must have a Trusted Platform Module (TPM) enabled and ready for use. | Running Instances Check."
        ansible.builtin.debug:
            msg:
                - "Warning!! Please confirm TPM status is Ready for use, there are no instances currently running."
        when: "'No Instance' in wn16_00_000010_tpm_status.stderr_lines | string"

      - name: "MEDIUM | WN16-00-000100 | AUDIT | Windows Server 2016 domain-joined systems must have a Trusted Platform Module (TPM) enabled and ready for use. | Full TPM Check."
        ansible.builtin.debug:
            msg:
                - "Warning!! Please confirm TPM status is Ready for use. Current settings do not meet STIG requirements."
        when:
            - "'No Instance' not in wn16_00_000010_tpm_status.stderr_lines | string"
            - "'IsActivated_InitialValue=TRUE' not in wn16_00_000010_tpm_status.stderr_lines | string"
            - "'IsEnabled_InitialValue=TRUE' not in wn16_00_000010_tpm_status.stderr_lines | string"
            - "'IsOwned_InitialValue=TRUE' not in wn16_00_000010_tpm_status.stderr_lines | string"
            - "'SpecVersion=2' or 'SpecVersion=1.2' not in wn16_00_000010_tpm_status.stderr_lines | string"

      - name: "MEDIUM | WN16-00-000100 | AUDIT | Windows Server 2016 domain-joined systems must have a Trusted Platform Module (TPM) enabled and ready for use. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000100'
        when:
            - "'No Instance' not in wn16_00_000010_tpm_status.stderr_lines | string"
            - "'IsActivated_InitialValue=TRUE' not in wn16_00_000010_tpm_status.stderr_lines | string"
            - "'IsEnabled_InitialValue=TRUE' not in wn16_00_000010_tpm_status.stderr_lines | string"
            - "'IsOwned_InitialValue=TRUE' not in wn16_00_000010_tpm_status.stderr_lines | string"
            - "'SpecVersion=2.0' or 'SpecVersion=1.2' not in wn16_00_000010_tpm_status.stderr_lines | string or
              'No Instance' in wn16_00_000010_tpm_status.stderr_lines | string"
  when:
      - wn16_00_000100
      - ansible_windows_domain_member
  tags:
      - WN16-00-000100
      - V-224827
      - SV-224827r902425_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2
# Current hardware and virtual environments may not support virtualization-based security features, including Credential Guard, due to specific supporting requirements including a TPM, UEFI with Secure Boot, and the capability to run the Hyper-V feature within a virtual machine.

- name: "MEDIUM | WN16-00-000140 | AUDIT | Servers must have a host-based intrusion detection or prevention system."
  block:
      - name: "MEDIUM | WN16-00-000140 | AUDIT | Servers must have a host-based intrusion detection or prevention system. | Warning Message"
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2016 must have a host-based intrusion detection or prevention system."

      - name: "MEDIUM | WN16-00-000140 | AUDIT | Servers must have a host-based intrusion detection or prevention system. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000140'
  when:
      - wn16_00_000140
  tags:
      - WN16-00-000140
      - V-224830
      - SV-224830r793223_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2
      # think this is mcafee but need install and figure out paths for AV vs HIDS and/or running services?

- name: "MEDIUM | WN16-00-000160 | AUDIT | Permissions for the system drive root directory usually C:\ must conform to minimum requirements."
  block:
      - name: "MEDIUM | WN16-00-000160 | AUDIT | Permissions for the system drive root directory usually C:\ must conform to minimum requirements. | Obtain icacls for Program Files."
        ansible.windows.win_shell: icacls "c:\program files"
        changed_when: false
        failed_when: false
        register: wn16_00_000160_drive_root_audit

      - name: "MEDIUM | WN16-00-000160 | AUDIT | Permissions for the system drive root directory usually C:\ must conform to minimum requirements. | Manual Audit icacls for Program Files."
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task to audit. Windows Server 2019 icacls program needs to meet"
                - "the STIG requirements. Please check the report below and compare to the STIG requirements."
                - "{{ wn16_00_000160_drive_root_audit.stdout_lines }}"

      - name: "MEDIUM | WN16-00-000160 | AUDIT | Permissions for the system drive root directory usually C:\ must conform to minimum requirements. | Warn Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000160'
  when:
      - wn16_00_000160
  tags:
      - WN16-00-000160
      - V-224832
      - SV-224832r852289_rule
      - SRG-OS-000312-GPOS-00122
      - CCI-002165
      - CAT2
      # investigate icacls https://ss64.com/nt/icacls.html?

- name: "MEDIUM | WN16-00-000170 | AUDIT | Permissions for program file directories must conform to minimum requirements."
  block:
      - name: "MEDIUM | WN16-00-000170 | AUDIT | Permissions for program file directories must conform to minimum requirements. | Obtain icacls for Program Files."
        ansible.windows.win_shell: icacls "c:\program files"
        changed_when: false
        failed_when: false
        register: wn16_00_000170_program_files_audit

      - name: "MEDIUM | WN16-00-000170 | AUDIT | Permissions for program file directories must conform to minimum requirements. | Manual Audit icacls for Program Files."
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task to audit. Windows Server 2016 icacls program needs to meet"
                - "the STIG requirements. Please check the report below and compare to the STIG requirements."
                - "{{ wn16_00_000170_program_files_audit.stdout_lines }}"

      - name: "MEDIUM | WN16-00-000170 | AUDIT | Permissions for program file directories must conform to minimum requirements. | Obtain icacls for Program Files x86"
        ansible.windows.win_shell: icacls "c:\program files (x86)"
        changed_when: false
        failed_when: false
        register: wn16_00_000170_program_files_86_audit

      - name: "MEDIUM | WN16-00-000170 | AUDIT | Permissions for program file directories must conform to minimum requirements. | Manual Audit icacls for Program Files x86."
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task to audit. Windows Server 2016 icacls program files x86 needs to meet"
                - "the STIG requirements. Please check the report below and compare to the STIG requirements."
                - "{{ wn16_00_000170_program_files_86_audit.stdout_lines }}"

      - name: "MEDIUM | WN16-00-000170 | AUDIT | Permissions for program file directories must conform to minimum requirements. | Warn Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000170'
  when:
      - wn16_00_000170
  tags:
      - WN16-00-000170
      - V-224833
      - SV-224833r852290_rule
      - SRG-OS-000312-GPOS-00122
      - CCI-002165
      - CAT2
# Investigate a better way to the do the when statement and figure out why it is mot reading the when statement
# possible issue with the : or \ in them.
# when:
# - "'c:\\program files NT SERVICE\\TrustedInstaller:(F)' in wn16_00_000170_program_files_audit.stdout_lines | string"
# - "'NT SERVICE\\TrustedInstaller:(F)' not in wn16_00_000170_program_files_audit.stdout | string"
# - "'NT SERVICE\\TrustedInstaller:(CI)(IO)(F)' not in wn16_00_000170_program_files_audit.stdout | string"
# - "'NT AUTHORITY\\SYSTEM:(M)' not in wn16_00_000170_program_files_audit.stdout | string"
# - "'NT AUTHORITY\\SYSTEM:(OI)(CI)(IO)(F)' not in wn16_00_000170_program_files_audit.stdout | string"
# - "'BUILTIN\\Administrators:(M)' not in wn16_00_000170_program_files_audit.stdout | string"
# - "'BUILTIN\\Administrators:(OI)(CI)(IO)(F)' not in wn16_00_000170_program_files_audit.stdout | string"
# - "'BUILTIN\\Users:(RX)' not in wn16_00_000170_program_files_audit.stdout | string"
# - "'BUILTIN\\Users:(OI)(CI)(IO)(GR,GE)' not in wn16_00_000170_program_files_audit.stdout | string"
# - "'CREATOR OWNER:(OI)(CI)(IO)(F)' not in wn16_00_000170_program_files_audit.stdout | string"
# - "'APPLICATION PACKAGE AUTHORITY\\ALL APPLICATION PACKAGES:(RX)' not in wn16_00_000170_program_files_audit.stdout | string"
# - "'APPLICATION PACKAGE AUTHORITY\\ALL APPLICATION PACKAGES:(OI)(CI)(IO)(GR,GE)' not in wn16_00_000170_program_files_audit.stdout | string"
# - "'APPLICATION PACKAGE AUTHORITY\\ALL RESTRICTED APPLICATION PACKAGES:(RX)' not in wn16_00_000170_program_files_audit.stdout | string"
# - "'APPLICATION PACKAGE AUTHORITY\\ALL RESTRICTED APPLICATION PACKAGES:(OI)(CI)(IO)(GR,GE)' not in wn16_00_000170_program_files_audit.stdout | string"
# - "'Successfully processed 1 files; Failed processing 0 files' not in wn16_00_000170_program_files_audit.stdout | string"

- name: "MEDIUM | WN16-00-000180 | AUDIT | Permissions for the Windows installation directory must conform to minimum requirements."
  block:
      - name: "MEDIUM | WN16-00-000180 | AUDIT | Permissions for the Windows installation directory must conform to minimum requirements. | Obtain icacls for Windows Directory."
        ansible.windows.win_shell: icacls "c:\windows"
        changed_when: false
        failed_when: false
        register: wn16_00_000180_windows_dir_audit

      - name: "MEDIUM | WN16-00-000180 | AUDIT | Permissions for the Windows installation directory must conform to minimum requirements. | Warning Message."
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task to audit. Windows Server 2016 permissions for the Windows installation directory needs to meet"
                - "the STIG requirements. Please check the report below and compare to the STIG requirements."
                - "{{ wn16_00_000180_windows_dir_audit.stdout_lines }}"

      - name: "MEDIUM | WN16-00-000180 | AUDIT | Permissions for the Windows installation directory must conform to minimum requirements. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000180'
  when:
      - wn16_00_000180
  tags:
      - WN16-00-000180
      - V-224834
      - SV-224834r852291_rule
      - SRG-OS-000312-GPOS-00122
      - CCI-002165
      - CAT2

- name: "MEDIUM | WN16-00-000190 | AUDIT | Default permissions for the HKEY_LOCAL_MACHINE registry hive must be maintained."
  block:
      - name: "MEDIUM | WN16-00-000190 | AUDIT | Default permissions for the HKEY_LOCAL_MACHINE registry hive must be maintained. | Warning Message"
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2016 default permissions for the HKEY_LOCAL_MACHINE registry hive must be maintained."

      - name: "MEDIUM | WN16-00-000190 | AUDIT | Default permissions for the HKEY_LOCAL_MACHINE registry hive must be maintained. | Warn Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000190'
  when:
      - wn16_00_000190
  tags:
      - WN16-00-000190
      - V-224835
      - SV-224835r877392_rule
      - SRG-OS-000324-GPOS-00125
      - CCI-002235
      - CAT2
      # Get-Acl -Path HKLM:\"Software"

- name: "MEDIUM | WN16-00-000210 | AUDIT | Outdated or unused accounts must be removed from the system or disabled."
  block:
      - name: "MEDIUM | WN16-00-000210 | AUDIT - DOMAIN CONTROLLERS | Outdated or unused accounts must be removed from the system or disabled | Audit System."
        ansible.windows.win_shell: Search-ADAccount -AccountInactive -UsersOnly -TimeSpan 35.00:00:00
        changed_when: false
        failed_when: false
        register: wn16_00_000210_account_audit_dc
        when: ansible_windows_domain_role == "Primary domain controller"

      - name: "MEDIUM | WN16-00-000210 | AUDIT - DOMAIN CONTROLLERS | Outdated or unused accounts must be removed from the system or disabled. | Warning Message."
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Outdated or unused accounts must be removed from"
                - "the Windows Server 2016 system or disabled."
                - "Accounts to exclude are the following:"
                - "Built-in administrator account (Renamed, SID ending in 500)"
                - "Built-in guest account (Renamed, Disabled, SID ending in 501)"
                - "Built-in default account (Renamed, Disabled, SID ending in 503)"
                - "Application accounts"
                - "Below is the list of User accounts found on the system. Please check the report"
                - "below and compare the the STIG requirements."
                - "----------------------------------------------------------"
                - "{{ wn16_00_000210_account_audit_dc.stdout.split('\n') }}"
                - "----------------------------------------------------------"
        when:
            - wn16_00_000210_account_audit_dc is not skipped
            - wn16_00_000210_account_audit_dc.stdout != ""

      - name: "MEDIUM | WN16-00-000210 | AUDIT - DOMAIN MEMBERS OR STANDALONE | Outdated or unused accounts must be removed from the system or disabled. | Audit User Accounts"
        ansible.windows.win_shell: |
                                ([ADSI]('WinNT://{0}' -f $env:COMPUTERNAME)).Children | Where {
                                $_.SchemaClassName -eq 'user' } | ForEach {
                                $user = ([ADSI]$_.Path)
                                $lastLogin = $user.Properties.LastLogin.Value
                                $enabled = ($user.Properties.UserFlags.Value -band 0x2) -ne 0x2
                                if ($lastLogin -eq $null) {
                                $lastLogin = 'Never'
                                }
                                Write-Host UserName: $user.Name LastLogin: $lastLogin Enabled: $enabled
                                }
        changed_when: false
        failed_when: false
        register: wn16_00_000210_account_audit_dm_sa
        when: not ansible_windows_domain_role == "Primary domain controller"

      - name: "MEDIUM | WN16-00-000210 | AUDIT - DOMAIN MEMBERS OR STANDALONE | Outdated or unused accounts must be removed from the system or disabled. | Warning Message."
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Outdated or unused accounts must be removed from"
                - "the Windows Server 2016 system or disabled."
                - "Accounts to exclude are the following:"
                - "Built-in administrator account (Renamed, SID ending in 500)"
                - "Built-in guest account (Renamed, Disabled, SID ending in 501)"
                - "Built-in default account (Renamed, Disabled, SID ending in 503)"
                - "Application accounts"
                - "Below is the list of User accounts found on the system. Please check the report"
                - "below and compare the the STIG requirements."
                - "----------------------------------------------------------"
                - "{{ wn16_00_000210_account_audit_dm_sa.stdout.split('\n') }}"
                - "----------------------------------------------------------"
        when:
            - wn16_00_000210_account_audit_dm_sa is not skipped
            - wn16_00_000210_account_audit_dm_sa.stdout != ""

      - name: "MEDIUM | WN16-00-000210 | AUDIT | Outdated or unused accounts must be removed from the system or disabled. | Warn Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000210'
        when: wn16_00_000210_account_audit_dc is not skipped and wn16_00_000210_account_audit_dc.stdout != "" or wn16_00_000210_account_audit_dm_sa is not skipped and wn16_00_000210_account_audit_dm_sa.stdout != ""
  when:
      - wn16_00_000210
  tags:
      - WN16-00-000210
      - V-224837
      - SV-224837r857230_rule
      - SRG-OS-000104-GPOS-00051
      - CCI-000764
      - CCI-000795
      - CAT2
# $sid.Translate( [Security.Principal.Securityidentifier] ).Value <-- potentialto use in 2019 did not work in 2016

- name: "MEDIUM | WN16-00-000220 | AUDIT | Windows Server 2016 accounts must require passwords."
  block:
      - name: "MEDIUM | WN16-00-000220 | AUDIT - DOMAIN CONTROLLER | Windows Server 2016 accounts must require passwords. | Audit Accounts."
        ansible.windows.win_shell: Get-Aduser -Filter "(Passwordnotrequired -eq 'True') -and (Enabled -eq 'True')" | Select Name,Passwordnotrequired,Enabled
        changed_when: false
        failed_when: false
        register: wn16_00_000220_audit_dc
        when: ansible_windows_domain_role == "Primary domain controller"

      - name: "MEDIUM | WN16-00-000220 | AUDIT - DOMAIN CONTROLLER | Windows Server 2016 accounts must require passwords. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "The accounts listed do not require a password and are currently enabled."
                - "To conform to STIG complaince configure passwords on all accounts."
                - "{{ wn16_00_000220_audit_dc.stdout.split('\n') }}"
        when:
            - wn16_00_000220_audit_dc is not skipped
            - wn16_00_000220_audit_dc.stdout != ""

      - name: "MEDIUM | WN16-00-000220 | AUDIT - DOMAIN MEMBERS OR STANDALONE | Windows Server 2016 accounts must require passwords. | Audit Local Accounts"
        ansible.windows.win_shell: Get-LocalUser | Where-Object {($_.PasswordRequired -ne 'True' -and $_.Enabled -eq 'True')} | Select Name,PasswordRequired,Enabled
        changed_when: false
        failed_when: false
        register: wn16_00_000220_audit_dm_sa
        when: not ansible_windows_domain_role == "Primary domain controller"

      - name: "MEDIUM | WN16-00-000220 | AUDIT - DOMAIN MEMBERS OR STANDALONE | Windows Server 2016 accounts must require passwords. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "The accounts listed do not require a password and are currently enabled."
                - "To conform to STIG complaince configure passwords on all accounts."
                - "{{ wn16_00_000220_audit_dm_sa.stdout.split('\n') }}"
        when:
            - wn16_00_000220_audit_dm_sa is not skipped
            - wn16_00_000220_audit_dm_sa.stdout != ""

      - name: "MEDIUM | WN16-00-000220 | AUDIT | Windows Server 2016 accounts must require passwords. | Warning Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000220'
        when:
            - wn16_00_000220_audit_dc is not skipped and wn16_00_000220_audit_dc.stdout != "" or
              wn16_00_000220_audit_dm_sa is not skipped and wn16_00_000220_audit_dm_sa.stdout != ""
  when:
      - wn16_00_000220
  tags:
      - WN16-00-000220
      - V-224838
      - SV-224838r857232_rule
      - SRG-OS-000104-GPOS-00051
      - CCI-000764
      - CAT2
      - password

- name: "MEDIUM | WN16-00-000230 | AUDIT | Passwords must be configured to expire."
  block:
      - name: "MEDIUM | WN16-00-000230 | AUDIT - DOMAIN CONTROLLER | Passwords must be configured to expire. | Audit Accounts."
        ansible.windows.win_shell: Search-ADAccount -PasswordNeverExpires -UsersOnly | FT Name, PasswordNeverExpires, Enabled
        changed_when: false
        failed_when: false
        register: wn16_00_000230_audit_dc
        when: ansible_windows_domain_role == "Primary domain controller"

      - name: "MEDIUM | WN16-00-000230 | AUDIT - DOMAIN CONTROLLER | Passwords must be configured to expire. | Warning Message."
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Windows Server 2016 passwords must be configured to expire."
                - "The Following Accounts may not conform To STIG Standards."
                - "{{ wn16_00_000230_audit_dc.stdout.split('\n') }}"
        when:
            - wn16_00_000230_audit_dc is not skipped
            - wn16_00_000230_audit_dc.stdout != ""

      - name: "MEDIUM | WN16-00-000230 | AUDIT - DOMAIN MEMBERS OR STANDALONE | Passwords must be configured to expire. | Audit Local Accounts."
        ansible.windows.win_shell: |
                Get-CimInstance -Class Win32_Useraccount -Filter "PasswordExpires=False and LocalAccount=True" |
                Where-Object -FilterScript {$_.PasswordExpires -EQ $False -AND $_.Disabled -EQ $False} |
                Format-Table -Property Name,PasswordExpires,Disabled,LocalAccount
        changed_when: false
        failed_when: false
        register: wn16_00_000230_audit_dm_sa
        when: not ansible_windows_domain_role == "Primary domain controller"

      - name: "MEDIUM | WN16-00-000230 | AUDIT - DOMAIN MEMBERS OR STANDALONE | Passwords must be configured to expire. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Windows Server 2016 passwords must be configured to expire."
                - "The Following Accounts may not conform To STIG Standards."
                - "{{ wn16_00_000230_audit_dm_sa.stdout.split('\n') }}"
        when:
            - wn16_00_000230_audit_dm_sa is not skipped
            - wn16_00_000230_audit_dm_sa.stdout != ""

      - name: "MEDIUM | WN16-00-000230 | AUDIT | Windows Server 2016 passwords must be configured to expire. | Warning Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000230'
        when:
            - wn16_00_000230_audit_dc is not skipped and wn16_00_000230_audit_dc.stdout != "" or
              wn16_00_000230_audit_dm_sa is not skipped and wn16_00_000230_audit_dm_sa.stdout != ""
  when:
      - wn16_00_000230
  tags:
      - WN16-00-000230
      - V-224839
      - SV-224839r857235_rule
      - SRG-OS-000076-GPOS-00044
      - CCI-000199
      - CAT2

- name: "MEDIUM | WN16-00-000240 | AUDIT | System files must be monitored for unauthorized changes."
  block:
      - name: "MEDIUM | WN16-00-000240 | AUDIT | System files must be monitored for unauthorized changes. | Warning Message."
        ansible.builtin.debug:
            msg: "Warning!! This is a manual task. Windows Server 2016 system files must be monitored for unauthorized changes."

      - name: "MEDIUM | WN16-00-000240 | AUDIT | System files must be monitored for unauthorized changes. | Warn Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000240'
  when:
      - wn16_00_000240
  tags:
      - WN16-00-000240
      - V-224840
      - SV-224840r891691_rule
      - SRG-OS-000363-GPOS-00150
      - CCI-001744
      - CAT2

- name: "MEDIUM | WN16-00-000250 | AUDIT | Non-system-created file shares on a system must limit access to groups that require it."
  block:
      - name: "MEDIUM | WN16-00-000250 | AUDIT | Non-system-created file shares on a system must limit access to groups that require it. | Audit Shares"
        ansible.windows.win_shell: Get-SmbShare | Where-Object { ($_.Name -notlike "ADMIN$") -and ($_.Name -notlike 'C$') -and ($_.Name -notlike 'IPC$') } | Select-Object -Property Name | format-table -hidetableheaders
        changed_when: false
        failed_when: false
        register: wn16_00_000250_audit

      - name: "MEDIUM | WN16-00-000250 | AUDIT | Non-system-created file shares on a system must limit access to groups that require it. | Warning Message."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have shares that non-system created. Please manually review those shares listed below to make sure appropriate permissions are applied"
                - "{{ wn16_00_000250_audit.stdout_lines | select() | list }}"
        when: wn16_00_000250_audit.stdout_lines | select() | length > 0

      - name: "MEDIUM | WN16-00-000250 | AUDIT | Non-system-created file shares on a system must limit access to groups that require it. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000250'
        when: wn16_00_000250_audit.stdout_lines | select() | length > 0
  when:
      - wn16_00_000250
  tags:
      - WN16-00-000250
      - V-224841
      - SV-224841r569186_rule
      - SRG-OS-000138-GPOS-00069
      - CCI-001090
      - CAT2

# https://stackoverflow.com/questions/31049454/how-to-retrieve-recursively-any-files-with-a-specific-extensions-in-powershell/31049571
- name: "MEDIUM | WN16-00-000270 | AUDIT | Software certificate installation files must be removed from Windows Server 2016."
  block:
      - name: "MEDIUM | WN16-00-000270 | AUDIT | Software certificate installation files must be removed from Windows Server 2016. | Search for files"
        ansible.windows.win_find:
            paths: '{{ item }}:\'
            patterns: ['*.p12', '*.pfx']
            recurse: true
            hidden: true
        register: wn16_00_000270_files
        with_items: "{{ wn16_drive_letters.stdout_lines }}"

      - name: "MEDIUM | WN16-00-000270 | PATCH | Software certificate installation files must be removed from Windows Server 2016. | Remove Files"
        ansible.windows.win_file:
            path: "{{ item.path }}"
            state: absent
        with_items:
            - "{{ wn16_00_000270_files.results[0].files }}"
        loop_control:
            label: "{{ item.path }}"
        when:
            - win2016stig_disruption_high
            - wn16_00_000270_files.results[0].files | length > 0

      - name: "MEDIUM | WN16-00-000270 | AUDIT | Software certificate installation files must be removed from Windows Server 2016. | Alert on files if not Disruptive High"
        ansible.builtin.debug:
            msg:
                - "Warning!! You have .p12 and/or .pfx files on your system"
                - "Please review and remove the following files manually.  If you"
                - "would like them removed with automation set win2016stig_disruption_high: true"
                - "Any files not removed must be documented with the ISSO."
                - "{{ wn16_00_000270_files.results[0].files | map(attribute='path') | list }}"
        when:
            - not win2016stig_disruption_high
            - wn16_00_000270_files.results[0].files | length > 0

      - name: "MEDIUM |WN16-00-000270 | AUDIT | Software certificate installation files must be removed from Windows Server 2016. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000270'
        when:
            - not win2016stig_disruption_high
            - wn16_00_000270_files.results[0].files | length > 0
  when:
      - wn16_00_000270
      - win16stig_lengthy_search
  tags:
      - WN16-00-000270
      - V-224842
      - SV-224842r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-00-000280 | AUDIT | Systems requiring data at rest protections must employ cryptographic mechanisms to prevent unauthorized disclosure and modification of the information at rest."
  block:
      - name: "MEDIUM | WN16-00-000280 | AUDIT | Systems requiring data at rest protections must employ cryptographic mechanisms to prevent unauthorized disclosure and modification of the information at rest. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Windows Server 2016 systems requiring data at rest protections"
                - "must employ cryptographic mechanisms to prevent unauthorized disclosure and modification of the information at rest. "

      - name: "MEDIUM | WN16-00-000280 | AUDIT | Systems requiring data at rest protections must employ cryptographic mechanisms to prevent unauthorized disclosure and modification of the information at rest. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN19-00-000250'
  when:
      - wn16_00_000280
  tags:
      - WN16-00-000280
      - V-224843
      - SV-224843r852297_rule
      - SRG-OS-000185-GPOS-00079
      - CCI-001199
      - CCI-002475
      - CCI-002476
      - CAT2

- name: "MEDIUM | WN16-00-000290 | AUDIT | Protection methods such as TLS, encrypted VPNs, or IPsec must be implemented if the data owner has a strict requirement for ensuring data integrity and confidentiality is maintained at every step of the data transfer and handling process."
  block:
      - name: "MEDIUM | WN16-00-000290 | AUDIT | Protection methods such as TLS, encrypted VPNs, or IPsec must be implemented if the data owner has a strict requirement for ensuring data integrity and confidentiality is maintained at every step of the data transfer and handling process. | Warnign Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Windows Server 2016 must implement protection methods such as TLS, encrypted VPNs,"
                - "or IPsec if the data owner has a strict requirement for ensuring"
                - "data integrity and confidentiality is maintained at every step of the data transfer and handling process."

      - name: "MEDIUM | WN16-00-000290 | AUDIT | Protection methods such as TLS, encrypted VPNs, or IPsec must be implemented if the data owner has a strict requirement for ensuring data integrity and confidentiality is maintained at every step of the data transfer and handling process. | Warn Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000290'
  when:
      - wn16_00_000290
  tags:
      - WN16-00-000290
      - V-224844
      - SV-224844r852298_rule
      - SRG-OS-000425-GPOS-00189
      - CCI-002420
      - CCI-002422
      - CAT2

- name: "MEDIUM | WN16-00-000300 | AUDIT | The roles and features required by the system must be documented."
  block:
      - name: "MEDIUM | WN16-00-000300 | AUDIT | The roles and features required by the system must be documented. | Audit The System"
        ansible.windows.win_shell: Get-WindowsFeature | Where-Object -FilterScript {$_.Installed -EQ $True}
        changed_when: false
        failed_when: false
        register: wn16_00_000300_audit

      - name: "MEDIUM | WN16-00-000300 | AUDIT | The roles and features required by the system must be documented. | Warning Message."
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Windows Server 2016 must have the roles"
                - "and features required by the system documented. Below is the current list of"
                - "roles and features installed on the system."
                - "Document the roles and features required for the system to operate. Uninstall any that are not required."
                - "{{ wn16_00_000300_audit.stdout_lines }}"

      - name: "MEDIUM | WN16-00-000300 | AUDIT | The roles and features required by the system must be documented. | Warning Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000300'
  when:
      - wn16_00_000300
  tags:
      - WN16-00-000300
      - V-224845
      - SV-224845r569186_rule
      - SRG-OS-000095-GPOS-00049
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN16-00-000310 | AUDIT | A host-based firewall must be installed and enabled on the system."
  block:
      - name: "MEDIUM | WN16-00-000310 | AUDIT | A host-based firewall must be installed and enabled on the system. | Check For Windows Based Firewall Enabled."
        ansible.windows.win_shell: |
                            $FWProfiles = (Get-NetFirewallProfile);
                            Write-Host "Windows Firewall Profile Statuses" -Foregroundcolor Yellow;
                            $FWProfiles | %{
                                If($_.Enabled -eq 1){
                                    Write-Host "The Windows Firewall $($_.Name) profile is enabled"
                                    }Else{
                                    Write-Host "The Windows Firewall $($_.Name) profile is disabled"
                                    }
                                };
        changed_when: false
        failed_when: false
        register: wn16_00_000310_firewall_audit

      - name: "MEDIUM | WN16-00-000310 | AUDIT | A host-based firewall must be installed and enabled on the system. | Warning Message No Windows Firewall Enabled"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Windows Server 2016 must have a host-based firewall installed and enabled."
                - "Windows does not currently have its built in firewall enabled."
                - "Please check for 3rd party firewall and verify the configuration requirements conform to firewall STIG standards."
                - "{{ wn16_00_000310_firewall_audit.stdout_lines }}"
        when:
            - "'Domain profile is disabled' in wn16_00_000310_firewall_audit.stdout_lines | string"
            - "'Private profile is disabled' in wn16_00_000310_firewall_audit.stdout_lines | string"
            - "'Public profile is disabled' in wn16_00_000310_firewall_audit.stdout_lines | string"

      - name: "MEDIUM | WN16-00-000310 | AUDIT | A host-based firewall must be installed and enabled on the system. | Warning Message Windows Firewall On"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Windows Server 2016 must have a host-based firewall installed and enabled."
                - "Windows host based firewall currently is enabled on Domain, Private, And Public Profiles."
                - "Please check the firewall and verify the configuration requirements conform to firewall STIG standards."
                - "{{ wn16_00_000310_firewall_audit.stdout_lines }}"
        when:
            - "'Domain profile is enabled' in wn16_00_000310_firewall_audit.stdout_lines | string"
            - "'Private profile is enabled' in wn16_00_000310_firewall_audit.stdout_lines | string"
            - "'Public profile is enabled' in wn16_00_000310_firewall_audit.stdout_lines | string"

      - name: "MEDIUM | WN16-00-000310 | AUDIT | A host-based firewall must be installed and enabled on the system. | Warning Message Windows Firewall Not Completely On"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Windows Server 2016 must have a host-based firewall installed and enabled."
                - "Windows host based firewall currently is partially enabled on Domain, Private, And Public Profiles."
                - "Please check the firewall and verify the configuration requirements conform to firewall STIG standards."
                - "{{ wn16_00_000310_firewall_audit.stdout_lines }}"
        when:
            - "'Domain profile is enabled' not in wn16_00_000310_firewall_audit.stdout_lines | string or
               'Private profile is enabled' not in wn16_00_000310_firewall_audit.stdout_lines | string or
               'Public profile is enabled' not in wn16_00_000310_firewall_audit.stdout_lines | string"

      - name: "MEDIUM | WN16-00-000310 | AUDIT | A host-based firewall must be installed and enabled on the system. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000310'
  when:
      - wn16_00_000310
  tags:
      - WN16-00-000310
      - V-224846
      - SV-224846r852299_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-00-000320 | AUDIT | Windows Server 2016 must employ automated mechanisms to determine the state of system components with regard to flaw remediation using the following frequency: continuously, where Host Based Security System (HBSS) is used; 30 days, for any additional internal network scans not covered by HBSS; and annually, for external scans by Computer Network Defense Service Provider (CNDSP)."
  block:
      - name: "MEDIUM | WN16-00-000320 | AUDIT | Windows Server 2016 must employ automated mechanisms to determine the state of system components with regard to flaw remediation using the following frequency: continuously, where Host Based Security System (HBSS) is used; 30 days, for any additional internal network scans not covered by HBSS; and annually, for external scans by Computer Network Defense Service Provider (CNDSP). | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Windows Server 2016 must employ automated mechanisms to determine the state of system"
                - "components with regard to flaw remediation using the following frequency: continuously, where Host Based Security System"
                - "(HBSS) is used; 30 days, for any additional internal network scans not covered by HBSS; and annually, for external scans"
                - "by Computer Network Defense Service Provider (CNDSP). Verify DoD-approved ESS software is installed and properly operating."
                - "Ask the site ISSM for documentation of the ESS software installation and configuration."

      - name: "MEDIUM | WN16-00-000320 | PATCH | Windows Server 2016 must employ automated mechanisms to determine the state of system components with regard to flaw remediation using the following frequency: continuously, where Host Based Security System (HBSS) is used; 30 days, for any additional internal network scans not covered by HBSS; and annually, for external scans by Computer Network Defense Service Provider (CNDSP). | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000320'
  when:
      - wn16_00_000320
  tags:
      - WN16-00-000320
      - V-224847
      - SV-224847r793221_rule
      - SRG-OS-000191-GPOS-00080
      - CCI-001233
      - CAT2

- name: "MEDIUM | WN16-00-000330 | AUDIT | Windows Server 2016 must automatically remove or disable temporary user accounts after 72 hours."
  block:
      - name: "MEDIUM | WN16-00-000330 | AUDIT - DOMAIN CONTROLLER | Windows Server 2016 must automatically remove or disable temporary user accounts after 72 hours. | Get User List."
        ansible.windows.win_shell: Search-ADAccount -AccountExpiring | FT Name, AccountExpirationDate
        changed_when: false
        failed_when: false
        register: wn16_00_000330_audit_dc
        when: ansible_windows_domain_role == "Primary domain controller"

      - name: "MEDIUM | WN16-00-000330 | AUDIT - DOMAIN CONTROLLER | Windows Server 2016 must automatically remove or disable temporary user accounts after 72 hours. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Please review all accounts to verify there are no temporary accounts"
                - "listed where the expiration date is longer then 72 hours."
                - "{{ wn16_00_000330_audit_dc.stdout.split('\n') }}"
        when:
            - wn16_00_000330_audit_dc is not skipped
            - wn16_00_000330_audit_dc.stdout != ""

      - name: "MEDIUM | WN16-00-000330 | AUDIT - DOMAIN MEMBERS OR STANDALONE | Windows Server 2016 must automatically remove or disable temporary user accounts after 72 hours. | Get User List."
        ansible.windows.win_shell: Get-LocalUser
        changed_when: false
        failed_when: false
        register: wn16_00_000330_audit_sa
        when: not ansible_windows_domain_role == "Primary domain controller"

      - name: "MEDIUM | WN16-00-000330 | AUDIT - DOMAIN MEMBERS OR STANDALONE | Windows Server 2016 must automatically remove or disable temporary user accounts after 72 hours. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Please review all accounts to verify there are no temporary accounts"
                - "listed where the expiration date is longer then 72 hours."
                - "{{ wn16_00_000330_audit_sa.stdout.split('\n') }}"
        when:
            - wn16_00_000330_audit_sa is not skipped
            - wn16_00_000330_audit_sa.stdout != ""

      - name: "MEDIUM | WN16-00-000330 | AUDIT | Windows Server 2016 must automatically remove or disable temporary user accounts after 72 hours. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000330'
        when:
            - wn16_00_000330_audit_dc is not skipped and wn16_00_000330_audit_dc.stdout != "" or
              wn16_00_000330_audit_sa is not skipped and wn16_00_000330_audit_sa.stdout != ""
  when:
      - wn16_00_000330
  tags:
      - WN16-00-000330
      - V-224848
      - SV-224848r857240_rule
      - SRG-OS-000002-GPOS-00002
      - CCI-000016
      - CAT2

- name: "MEDIUM | WN16-00-000340 | Windows Server 2016 must automatically remove or disable emergency accounts after the crisis is resolved or within 72 hours."
  block:
      - name: "MEDIUM | WN16-00-000340 | AUDIT - DOMAIN CONTROLLER | Windows Server 2016 must automatically remove or disable emergency accounts after the crisis is resolved or within 72 hours. | Get User List."
        ansible.windows.win_shell: Search-ADAccount -AccountExpiring | FT Name, AccountExpirationDate
        changed_when: false
        failed_when: false
        register: wn16_00_000340_audit_dc
        when: ansible_windows_domain_role == "Primary domain controller"

      - name: "MEDIUM | WN16-00-000340 | AUDIT - DOMAIN CONTROLLER | Windows Server 2016 must automatically remove or disable emergency accounts after the crisis is resolved or within 72 hours. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Windows Server 2016 must automatically remove or disable emergency"
                - "accounts after the crisis is resolved or within 72 hours."
                - "{{ wn16_00_000340_audit_dc.stdout.split('\n') }}"
        when:
            - wn16_00_000340_audit_dc is not skipped
            - wn16_00_000340_audit_dc.stdout != ""

      - name: "MEDIUM | WN16-00-000340 | AUDIT - DOMAIN MEMBERS OR STANDALONE | Windows Server 2016 must automatically remove or disable emergency accounts after the crisis is resolved or within 72 hours. | Get User List."
        ansible.windows.win_shell: Get-LocalUser
        changed_when: false
        failed_when: false
        register: wn16_00_000340_audit_sa
        when: not ansible_windows_domain_role == "Primary domain controller"

      - name: "MEDIUM | WN16-00-000340 | AUDIT - DOMAIN MEMBERS OR STANDALONE | Windows Server 2016 must automatically remove or disable emergency accounts after the crisis is resolved or within 72 hours. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Windows Server 2016 must automatically remove or disable emergency"
                - "accounts after the crisis is resolved or within 72 hours."
                - "{{ wn16_00_000340_audit_sa.stdout.split('\n') }}"
        when:
            - wn16_00_000340_audit_sa is not skipped
            - wn16_00_000340_audit_sa.stdout != ""

      - name: "MEDIUM | WN16-00-000340 | AUDIT | Windows Server 2016 must automatically remove or disable emergency accounts after the crisis is resolved or within 72 hours. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000340'
        when:
            - wn16_00_000340_audit_dc is not skipped and wn16_00_000340_audit_dc.stdout != "" or
              wn16_00_000340_audit_sa is not skipped and wn16_00_000340_audit_sa.stdout != ""
  when:
      - wn16_00_000340
  tags:
      - WN16-00-000340
      - V-224849
      - SV-224849r857243_rule
      - SRG-OS-000123-GPOS-00064
      - CCI-001682
      - CAT2

- name: "MEDIUM | WN16-00-000350 | PATCH | The Fax Server role must not be installed."
  ansible.windows.win_feature:
      name: Fax
      state: absent
  notify:
      - reboot_windows
  when:
      - wn16_00_000350
  tags:
      - WN16-00-000350
      - V-224850
      - SV-224850r569186_rule
      - SRG-OS-000095-GPOS-00049
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN16-00-000360 | PATCH | The Microsoft FTP service must not be installed unless required."
  ansible.windows.win_feature:
      name: Web-Ftp-Server
      state: absent
  notify:
      - reboot_windows
  when:
      - wn16_00_000360
  tags:
      - WN16-00-000360
      - V-224851
      - SV-224851r569186_rule
      - SRG-OS-000096-GPOS-00050
      - CCI-000382
      - CAT2

- name: "MEDIUM | WN16-00-000370 | PATCH | The Peer Name Resolution Protocol must not be installed."
  ansible.windows.win_feature:
      name: PNRP
      state: absent
  notify:
      - reboot_windows
  when:
      - wn16_00_000370
  tags:
      - WN16-00-000370
      - V-224852
      - SV-224852r569186_rule
      - SRG-OS-000095-GPOS-00049
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN16-00-000380 | PATCH | Simple TCP/IP Services must not be installed."
  ansible.windows.win_feature:
      name: Simple-TCPIP
      state: absent
  when:
      - wn16_00_000380
  tags:
      - WN16-00-000380
      - V-224853
      - SV-224853r569186_rule
      - SRG-OS-000095-GPOS-00049
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN16-00-000390 | PATCH | The Telnet Client must not be installed."
  ansible.windows.win_feature:
      name: Telnet-Client
      state: absent
  when:
      - wn16_00_000390
  tags:
      - WN16-00-000390
      - V-224854
      - SV-224854r569186_rule
      - SRG-OS-000096-GPOS-00050
      - CCI-000382
      - CAT2

- name: "MEDIUM | WN16-00-000400 | PATCH | The TFTP Client must not be installed."
  ansible.windows.win_feature:
      name: TFTP-Client
      state: absent
  when:
      - wn16_00_000400
  tags:
      - WN16-00-000400
      - V-224855
      - SV-224855r569186_rule
      - SRG-OS-000095-GPOS-00049
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN16-00-000410 | PATCH | The Server Message Block (SMB) v1 protocol must be uninstalled."
  ansible.windows.win_feature:
      name: FS-SMB1
      state: absent
  when:
      - wn16_00_000410
  tags:
      - WN16-00-000410
      - V-224856
      - SV-224856r569186_rule
      - SRG-OS-000095-GPOS-00049
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN16-00-000411 | PATCH | The Server Message Block (SMB) v1 protocol must be disabled on the SMB server."
  block:
      - name: "MEDIUM | WN16-00-000411 | PATCH | The Server Message Block (SMB) v1 protocol must be disabled on the SMB server. | Registry Edit"
        ansible.windows.win_regedit:
            path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters
            state: present
            value: SMB1
            data: 0
            datatype: dword
        notify: reboot_windows

      - name: "MEDIUM | WN16-00-000411 | AUDIT | The Server Message Block (SMB) v1 protocol must be disabled on the SMB server. | Warning Message No SecGuide.admx"
        ansible.builtin.debug:
            msg:
                - "Warning!! SecGuide.admx is not installed in C:\\Windows\\PolicyDefinitions folder."
                - "This policy setting requires the installation of the SecGuide.admx custom templates"
                - "included with the STIG package."
        when: wn16_secguide_admx_audit.results[0].matched != 1

      - name: "MEDIUM | WN16-00-000411 | AUDIT | The Server Message Block (SMB) v1 protocol must be disabled on the SMB server. | Warning Message No SecGuide.adml"
        ansible.builtin.debug:
            msg:
                - "Warning!! SecGuide.adml is not installed in C:\\Windows\\PolicyDefinitions\\en-US folder"
                - "This policy setting requires the installation of the SecGuide.adml custom templates"
                - "included with the STIG package."
        when: wn16_secguide_adml_audit.results[0].matched != 1

      - name: "MEDIUM | WN16-00-000411 | AUDIT | The Server Message Block (SMB) v1 protocol must be disabled on the SMB server. | Warning Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000411'
        when:
            - wn16_secguide_admx_audit.results[0].matched != 1 or
              wn16_secguide_adml_audit.results[0].matched != 1
  when:
      - wn16_00_000411
  tags:
      - WN16-00-000411
      - V-224857
      - SV-224857r569186_rule
      - SRG-OS-000095-GPOS-00049
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN16-00-000412 | PATCH | Server Message Block (SMB) v1 protocol must be disabled on the SMB client."
  block:
      - name: "MEDIUM | WN16-00-000412 | PATCH | The Server Message Block (SMB) v1 protocol must be disabled on the SMB client - mrxsmb10. | Set Registry Key"
        ansible.windows.win_regedit:
            path: HKLM:\SYSTEM\CurrentControlSet\Services\mrxsmb10
            state: present
            value: Start
            data: 4
            datatype: dword
        notify: reboot_windows

      - name: "MEDIUM | WN16-00-000412 | AUDIT | The Server Message Block (SMB) v1 protocol must be disabled on the SMB client - mrxsmb10. | Warning Message No SecGuide.admx"
        ansible.builtin.debug:
            msg:
                - "Warning!! SecGuide.admx is not installed in C:\\Windows\\PolicyDefinitions folder."
                - "This policy setting requires the installation of the SecGuide.admx custom templates"
                - "included with the STIG package."
        when: wn16_secguide_admx_audit.results[0].matched != 1

      - name: "MEDIUM | WN16-00-000412 | AUDIT | The Server Message Block (SMB) v1 protocol must be disabled on the SMB client - mrxsmb10. | Warning Message No SecGuide.adml"
        ansible.builtin.debug:
            msg:
                - "Warning!! SecGuide.adml is not installed in C:\\Windows\\PolicyDefinitions\\en-US folder"
                - "This policy setting requires the installation of the SecGuide.adml custom templates"
                - "included with the STIG package."
        when: wn16_secguide_adml_audit.results[0].matched != 1

      - name: "MEDIUM | WN16-00-000412 | AUDIT | The Server Message Block (SMB) v1 protocol must be disabled on the SMB client - mrxsmb10. | Warning Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000412'
        when:
            - wn16_secguide_admx_audit.results[0].matched != 1 or
              wn16_secguide_adml_audit.results[0].matched != 1
  when:
      - wn16_00_000412
  tags:
      - WN16-00-000412
      - V-224858
      - SV-224858r569186_rule
      - SRG-OS-000095-GPOS-00049
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN16-00-000420 | PATCH | Windows PowerShell 2.0 must not be installed."
  ansible.windows.win_feature:
      name: PowerShell-V2
      state: absent
  when:
      - wn16_00_000420
  tags:
      - WN16-00-000420
      - V-224859
      - SV-224859r569186_rule
      - SRG-OS-000095-GPOS-00049
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN16-00-000430 | AUDIT | FTP servers must be configured to prevent anonymous logons."
  block:
      - name: "MEDIUM | WN16-00-000430 | AUDIT | FTP servers must be configured to prevent anonymous logons. | Get FTP Installed Status."
        ansible.windows.win_shell: Get-WindowsFeature | Where Name -eq Web-Ftp-Service
        changed_when: false
        failed_when: false
        register: wn16_00_000430_audit

      - name: "MEDIUM | WN16-00-000430 | AUDIT | FTP servers must be configured to prevent anonymous logons. | Set Fact"
        ansible.builtin.set_fact:
            wn16_00_000430_ftp_audit: "{{ wn16_00_000430_audit.stdout_lines | regex_search('Installed') }}"

      - name: "MEDIUM | WN16-00-000430 | AUDIT | FTP servers must be configured to prevent anonymous logons. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Internet Information Services (IIS) Manager FTP is currently"
                - "installed on the system. Anonymous Authentication must be set to diabled per STIG Requirements."
        when: "'Installed' in wn16_00_000430_ftp_audit"

      - name: "MEDIUM | WN16-00-000430 | AUDIT | FTP servers must be configured to prevent anonymous logons. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000430'
        when: "'Installed' in wn16_00_000430_ftp_audit"
  when:
      - wn16_00_000430
  tags:
      - WN16-00-000430
      - V-224860
      - SV-224860r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-00-000440 | AUDIT | FTP servers must be configured to prevent access to the system drive."
  block:
      - name: "MEDIUM | WN16-00-000440 | AUDIT | FTP servers must be configured to prevent access to the system drive. | Get FTP Installed."
        ansible.windows.win_shell: Get-WindowsFeature | Where Name -eq Web-Ftp-Service
        changed_when: false
        failed_when: false
        register: wn16_00_000440_audit

      - name: "MEDIUM | WN16-00-000440 | AUDIT | FTP servers must be configured to prevent access to the system drive. | Set Fact."
        ansible.builtin.set_fact:
            wn16_00_000440_ftp_audit: "{{ wn16_00_000430_audit.stdout_lines | regex_search('Installed') }}"

      - name: "MEDIUM | WN16-00-000440 | AUDIT | FTP servers must be configured to prevent access to the system drive. | Get Sites Info."
        ansible.windows.win_shell: |
                                Import-Module IISAdministration
                                Get-IISSite
        changed_when: false
        failed_when: false
        register: wn16_00_000440_isssite_audit
        when: "'Installed' in wn16_00_000440_ftp_audit"

      - name: "MEDIUM | WN16-00-000440 | AUDIT | FTP servers must be configured to prevent access to the system drive. | Warning Message."
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. For any sites with a Binding that lists FTP, right-click the site and select Explore."
                - "If the site includes any system areas such as root of the drive, Program Files, or Windows directories, this is a finding"
                - "Configure the FTP sites to allow access only to specific FTP shared resources. Do not allow access to other areas of the system."
                - "{{ wn16_00_000440_isssite_audit.stdout.split('\n') }}"
        when: "'Installed' in wn16_00_000440_ftp_audit"

      - name: "MEDIUM | WN16-00-000440 | AUDIT | FTP servers must be configured to prevent access to the system drive. | Warn Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000440'
        when: "'Installed' in wn16_00_000440_ftp_audit"
  when:
      - wn16_00_000440
  tags:
      - WN16-00-000440
      - V-224861
      - SV-224861r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-00-000460 | AUDIT | Orphaned security identifiers (SIDs) must be removed from user rights on Windows 2016."
  block:
      - name: "MEDIUM | WN16-00-000460 | AUDIT | Orphaned security identifiers (SIDs) must be removed from user rights on Windows 2016. | Get User List"
        ansible.windows.win_shell: Get-WmiObject Win32_UserAccount | Where-Object {$_.SID -match "*S"} | Select Name,SID,DOMAIN
        changed_when: false
        failed_when: false
        register: wn16_00_000460_orphaned_user_accounts

      - name: "MEDIUM | WN16-00-000460 | AUDIT | Orphaned security identifiers (SIDs) must be removed from user rights on Windows 2016. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! Please review the User Rights listed for each of any unresolved SID to determine whether they are valid."
                - "User Accounts"
                - "----------------------------------------------------------------------"
                - "{{ wn16_00_000460_orphaned_user_accounts.stdout_lines }}"
        when: wn16_00_000460_orphaned_user_accounts.stdout_lines | select() | length > 0

      - name: "MEDIUM | WN16-00-000460 | AUDIT | Orphaned security identifiers (SIDs) must be removed from user rights on Windows 2016. | Check For Orphaned Group Accounts. | Get Group List"
        ansible.windows.win_shell: Get-WmiObject -Class Win32_UserAccount | Where-Object {$_.SID -match "*S"} | Select Name,SID,DOMAIN
        changed_when: false
        failed_when: false
        register: wn16_00_000460_orphaned_group_accounts

      - name: "MEDIUM | WN16-00-000460 | AUDIT | Orphaned security identifiers (SIDs) must be removed from user rights on Windows 2016. | Warning Message."
        ansible.builtin.debug:
            msg:
                - "Warning!! Please review the Group Rights listed for each of any unresolved SID to determine whether they are valid."
                - "Group Accounts"
                - "----------------------------------------------------------------------"
                - "{{ wn16_00_000460_orphaned_group_accounts.stdout_lines }}"
        when: wn16_00_000460_orphaned_group_accounts.stdout_lines | select() | length > 0

      - name: "MEDIUM | WN16-00-000460 | AUDIT | Orphaned security identifiers (SIDs) must be removed from user rights on Windows 2016. | Warning Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-00-000460'
        when:
            - wn16_00_000460_orphaned_user_accounts.stdout_lines | select() | length > 0 or
              wn16_00_000460_orphaned_group_accounts.stdout_lines | select() | length > 0
  when:
      - wn16_00_000460
  tags:
      - WN16-00-000460
      - V-224863
      - SV-224863r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2
      # https://www.stigviewer.com/stig/windows_server_2016/2019-01-16/finding/V-78127

# THE FOLLOWING 3 CONTROLS WILL FAIL UNLESS THEY ARE IN THE FOLLOWING ORDER FOR LOCAL BASED SYSTEMS.
- name: "MEDIUM | WN16-AC-000020 | PATCH | Windows Server 2016 must have the number of allowed bad logon attempts configured to three or less."
  block:
      - name: "MEDIUM | WN16-AC-000020 | AUDIT | Windows Server 2016 must have the number of allowed bad logon attempts configured to three or less. | Warning For Bad Variable."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid number of days set for wn16stig_lockoutbadcount please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - wn16stig_lockoutbadcount == 0 or
              wn16stig_lockoutbadcount > 3

      - name: "MEDIUM | WN16-AC-000020 | AUDIT | Windows Server 2016 must have the number of allowed bad logon attempts configured to three or less. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-AC-000020'
        when:
            - wn16stig_lockoutbadcount == 0 or
              wn16stig_lockoutbadcount > 3

      - name: "MEDIUM | WN16-AC-000020 | PATCH | Windows Server 2016 must have the number of allowed bad logon attempts configured to three or less."
        community.windows.win_security_policy:
            section: System Access
            key: LockoutBadCount
            value: "{{ wn16stig_lockoutbadcount }}"
        when:
            - wn16stig_lockoutbadcount > 0
            - wn16stig_lockoutbadcount <= 3
  when:
      - wn16_ac_000020
  tags:
      - WN16-AC-000020
      - V-224867
      - SV-224867r569186_rule
      - SRG-OS-000021-GPOS-00005
      - CCI-000044
      - CAT2

# below task is dependent on WN16-AC-000020, maybe custom fail when known error if WN16-AC-000020 not set? "The key 'ResetLockoutCount' in section 'System Access' is not a valid key, cannot set this value"
- name: "MEDIUM | WN16-AC-000030 | PATCH | Windows Server 2016 must have the period of time before the bad logon counter is reset configured to 15 minutes or greater."
  block:
      - name: MEDIUM | WN16-AC-000030 | AUDIT | Windows Server 2016 must have the period of time before the bad logon counter is reset configured to 15 minutes or greater. | Warning For Bad Variable."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid number of days set for wn16stig_resetlockoutcount please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when: wn16stig_resetlockoutcount < 15

      - name: MEDIUM | WN16-AC-000030 | AUDIT | Windows Server 2016 must have the period of time before the bad logon counter is reset configured to 15 minutes or greater. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-AC-000030'
        when: wn16stig_resetlockoutcount < 15

      - name: "MEDIUM | WN16-AC-000030 | PATCH | Windows Server 2016 must have the period of time before the bad logon counter is reset configured to 15 minutes or greater. | Apply Variable"
        community.windows.win_security_policy:
            section: System Access
            key: ResetLockoutCount
            value: "{{ wn16stig_resetlockoutcount }}"
        when: wn16stig_resetlockoutcount >= 15
  when:
      - wn16_ac_000030
  tags:
      - WN16-AC-000030
      - V-224868
      - SV-224868r852302_rule
      - SRG-OS-000021-GPOS-00005
      - CCI-000044
      - CAT2

# below task is dependent on WN16-AC-000020 and WN16-AC-000030, maybe custom fail when known error if WN16-AC-000020 not set? "The key 'LockoutDuration' in section 'System Access' is not a valid key, cannot set this value"
- name: "MEDIUM | WN16-AC-000010 | PATCH | Windows Server 2016 account lockout duration must be configured to 15 minutes or greater."
  block:
      - name: "MEDIUM | WN16-AC-000010 | AUDIT | Windows Server 2016 account lockout duration must be configured to 15 minutes or greater. | Warning For Bad Variable."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid number of minutes set for wn16stig_lockoutduration please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - wn16stig_lockoutduration < 15
            - wn16stig_lockoutduration > 0

      - name: "MEDIUM | WN16-AC-000010 | AUDIT | Windows Server 2016 account lockout duration must be configured to 15 minutes or greater. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-AC-000010'
        when:
            - wn16stig_lockoutduration < 15
            - wn16stig_lockoutduration > 0

      - name: "MEDIUM | WN16-AC-000010 | PATCH | Windows Server 2016 account lockout duration must be configured to 15 minutes or greater. | Apply Variable."
        community.windows.win_security_policy:
            section: System Access
            key: LockoutDuration
            value: "{{ wn16stig_lockoutduration }}"
        when:
            - wn16stig_lockoutduration == 0 or
              wn16stig_lockoutduration >= 15
  when:
      - wn16_ac_000010
  tags:
      - WN16-AC-000010
      - V-205795
      - SRG-OS-000329-GPOS-00128
      - SV-205795r569188_rule
      - CCI-002238
      - CAT2

- name: "MEDIUM | WN16-AC-000040 | PATCH | Windows Server 2016 password history must be configured to 24 passwords remembered."
  block:
      - name: "MEDIUM | WN16-AC-000040 | AUDIT | Windows Server 2016 password history must be configured to 24 passwords remembered. | Warning For Bad Variable."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid number remembered passwords set for wn16stig_passwordhistorysize please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when: wn16stig_passwordhistorysize < 24

      - name: "MEDIUM | WN16-AC-000040 | AUDIT | Windows Server 2016 password history must be configured to 24 passwords remembered. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-AC-000040 '
        when: wn16stig_passwordhistorysize < 24

      - name: "MEDIUM | WN16-AC-000040 | PATCH | Windows Server 2016 password history must be configured to 24 passwords remembered. | Apply Variable"
        community.windows.win_security_policy:
            section: System Access
            key: PasswordHistorySize
            value: "{{ wn16stig_passwordhistorysize }}"
        when: wn16stig_passwordhistorysize >= 24
  when:
      - wn16_ac_000040
  tags:
      - WN16-AC-000040
      - V-224869
      - SV-224869r569186_rule
      - SRG-OS-000077-GPOS-00045
      - CCI-000200
      - CAT2

- name: "MEDIUM | WN16-AC-000050 | PATCH | Windows Server 2016 maximum password age must be configured to 60 days or less."
  block:
      - name: "MEDIUM | WN16-AC-000050 | AUDIT | Windows Server 2016 maximum password age must be configured to 60 days or less. | Warning For Bad Variable."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid number of days set for wn16stig_maximumpasswordage please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - wn16stig_maximumpasswordage == 0 or
              wn16stig_maximumpasswordage > 60

      - name: "MEDIUM | WN16-AC-000050 | AUDIT | Windows Server 2016 maximum password age must be configured to 60 days or less. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-AC-000050'
        when:
            - wn16stig_maximumpasswordage == 0 or
              wn16stig_maximumpasswordage > 60

      - name: "MEDIUM | WN16-AC-000050 | PATCH | Windows Server 2016 maximum password age must be configured to 60 days or less. | Apply Variable."
        community.windows.win_security_policy:
            section: System Access
            key: MaximumPasswordAge
            value: "{{ wn16stig_maximumpasswordage }}"
        when:
            - wn16stig_maximumpasswordage > 0
            - wn16stig_maximumpasswordage <= 60
  when:
      - wn16_ac_000050
  tags:
      - WN16-AC-000050
      - V-224870
      - SV-224870r569186_rule
      - SRG-OS-000076-GPOS-00044
      - CCI-000199
      - CAT2

- name: "MEDIUM | WN16-AC-000060 | PATCH | Windows Server 2016 minimum password age must be configured to at least one day."
  block:
      - name: "MEDIUM | WN16-AC-000060 | AUDIT | Windows Server 2016 minimum password age must be configured to at least one day. | Warning For Bad Variable."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid number of days set for wn16stig_minimumpasswordage please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when: wn16stig_minimumpasswordage == 0

      - name: "MEDIUM | WN16-AC-000060 | AUDIT | Windows Server 2016 minimum password age must be configured to at least one day. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-AC-000060'
        when: wn16stig_minimumpasswordage == 0

      - name: "MEDIUM | WN16-AC-000060 | PATCH | Windows Server 2016 minimum password age must be configured to at least one day. | Set Variable."
        community.windows.win_security_policy:
            section: System Access
            key: MinimumPasswordAge
            value: "{{ wn16stig_minimumpasswordage }}"
        when: wn16stig_minimumpasswordage > 0
  when:
      - wn16_ac_000060
  tags:
      - WN16-AC-000060
      - V-224871
      - SV-224871r569186_rule
      - SRG-OS-000075-GPOS-00043
      - CCI-000198
      - CAT2

- name: "MEDIUM | WN16-AC-000070 | PATCH | Windows Server 2016 minimum password length must be configured to 14 characters."
  block:
      - name: "MEDIUM | WN16-AC-000070 | AUDIT | Windows Server 2016 minimum password length must be configured to 14 characters. | Warning For Bad Variable."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid password length for wn16stig_minimumpasswordlength please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when: wn16stig_minimumpasswordlength < 14

      - name: "MEDIUM | WN16-AC-000070 | AUDIT | Windows Server 2016 minimum password length must be configured to 14 characters. | Warn Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN19-AC-000070'
        when: wn16stig_minimumpasswordlength < 14

      - name: "MEDIUM | WN16-AC-000070 | PATCH | Windows Server 2016 minimum password length must be configured to 14 characters. | Apply Variable."
        community.windows.win_security_policy:
            section: System Access
            key: MinimumPasswordLength
            value: "{{ wn16stig_minimumpasswordlength }}"
        when: wn16stig_minimumpasswordlength >= 14
  when:
      - wn16_ac_000070
  tags:
      - WN19-AC-000070
      - V-224872
      - SV-224872r569186_rule
      - SRG-OS-000078-GPOS-00046
      - CCI-000205
      - CAT2

- name: "MEDIUM | WN16-AC-000080 | PATCH | Windows Server 2016 must have the built-in Windows password complexity policy enabled."
  community.windows.win_security_policy:
      section: System Access
      key: PasswordComplexity
      value: 1
  when:
      - wn16_ac_000080
  tags:
      - WN16-AC-000080
      - V-224873
      - SV-224873r569186_rule
      - SRG-OS-000069-GPOS-00037
      - CCI-000192
      - CCI-000193
      - CCI-000194
      - CCI-001619
      - CAT2

- name: "MEDIUM | WN16-AU-000010 | Audit records must be backed up to a different system or media than the system being audited."
  block:
      - name: "MEDIUM | WN16-AU-000010 | AUDIT | Audit records must be backed up to a different system or media than the system being audited. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Windows Server 2016 audit records must be backed up to a"
                - "different system or media than the system being audited. Establish and implement a process"
                - "for backing up log data to another system or media other than the system being audited."

      - name: "MEDIUM | WN16-AU-000010 | AUDIt | Audit records must be backed up to a different system or media than the system being audited. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-AU-000010'
  when:
      - wn16_au_000010
  tags:
      - WN16-AU-000010
      - V-224875
      - SV-224875r877390_rule
      - SRG-OS-000342-GPOS-00133
      - CCI-001851
      - CAT2

- name: "MEDIUM | WN16-AU-000020 | Windows Server 2016 must, at a minimum, off-load audit records of interconnected systems in real time and off-load standalone systems weekly."
  block:
      - name: "MEDIUM | WN16-AU-000020 | AUDIT | Windows Server 2016 must, at a minimum, off-load audit records of interconnected systems in real time and off-load standalone systems weekly. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Windows Server 2016 must, at a minimum, offload audit"
                - "records of interconnected systems in real time and offload standalone or nondomain-joined systems weekly."

      - name: "MEDIUM | WN16-AU-000020 | PATCH | Windows Server 2016 must, at a minimum, off-load audit records of interconnected systems in real time and off-load standalone systems weekly. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-AU-000020'
  when:
      - wn16_au_000020
  tags:
      - WN16-AU-000020
      - V-224876
      - SV-224876r860019_rule
      - SRG-OS-000479-GPOS-00224
      - CCI-001851
      - CAT2
      # hard one, either need to standardize on say log shipping like splunk or other is set?

- name: "MEDIUM | WN16-AU-000030 | AUDIT | Permissions for the Application event log must prevent access by non-privileged accounts."
  block:
      - name: "MEDIUM | WN16-AU-000030 | PATCH | Windows 2016 permissions for the Application event log must prevent access by non-privileged accounts. | Get Default Log Locations."
        ansible.windows.win_shell: Get-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Services\EventLog\Application\ | Select-Object File | ft -HideTableHeaders
        changed_when: false
        failed_when: false
        register: wn16_au_000030_app_log_location

      - name: "MEDIUM | WN16-AU-000030 | AUDIT | Windows 2016 permissions for the Application event log must prevent access by non-privileged accounts. | Get Current Permissions For Default Application Log."
        ansible.windows.win_shell: get-acl "{{ wn16_au_000030_app_log_location.stdout | trim }}" | FL AccessToString
        changed_when: false
        failed_when: false
        register: wn16_au_000030_app_log_permissions

      - name: "MEDIUM | WN16-AU-000030 | AUDIT | Windows 2016 permissions for the Application event log must prevent access by non-privileged accounts. | Permissions warning for accounts."
        ansible.builtin.debug:
            msg:
                - "Warning!! Ensure the permissions on the Application event log (Application.evtx) are configured"
                - "to prevent standard user accounts or groups from having access. The default permissions listed below satisfy this requirement:"
                - "Eventlog - Full Control, SYSTEM - Full Control, Administrators - Full Control"
                - "Current location of Application.evtx is {{ wn16_au_000030_app_log_location.stdout | trim }}"
                - "If the location of the logs has been changed, when adding Eventlog to the permissions,"
                - "it must be entered as NT Service\\Eventlog"
                - "{{ wn16_au_000030_app_log_permissions.stdout_lines | reject('match', '^$') | list }}"

      - name: "MEDIUM | WN16-AU-000030 | AUDIT | Windows 2016 permissions for the Application event log must prevent access by non-privileged accounts. | Warning Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-AU-000030'
  when:
      - wn16_au_000030
  tags:
      - WN16-AU-000030
      - V-224877
      - SV-224877r569186_rule
      - SRG-OS-000057-GPOS-00027
      - CCI-000162
      - CCI-000163
      - CCI-000164
      - CAT2

- name: "MEDIUM | WN16-AU-000040 | AUDIT | Permissions for the Security event log must prevent access by non-privileged accounts."
  block:
      - name: "MEDIUM | WN16-AU-000040 | AUDIT | Permissions for the Security event log must prevent access by non-privileged accounts. | Get Default Log Locations."
        ansible.windows.win_shell: Get-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Services\EventLog\Security\ | Select-Object File | ft -HideTableHeaders
        changed_when: false
        failed_when: false
        register: wn16_au_000040_sec_log_location

      - name: "MEDIUM | WN16-AU-000040 | AUDIT | Permissions for the Security event log must prevent access by non-privileged accounts. | Get Current Permissions For Default Security Log."
        ansible.windows.win_shell: get-acl "{{ wn16_au_000040_sec_log_location.stdout | trim }}" | FL AccessToString
        changed_when: false
        failed_when: false
        register: wn16_au_000040_sec_log_permissions

      - name: "MEDIUM | WN16-AU-000040 | AUDIT | Permissions for the Security event log must prevent access by non-privileged accounts. | Permissions warning for accounts."
        ansible.builtin.debug:
            msg:
                - "Warning!! Ensure the permissions on the Security event log (Security.evtx) are configured"
                - "to prevent standard user accounts or groups from having access. The default permissions listed below satisfy this requirement:"
                - "Eventlog - Full Control, SYSTEM - Full Control, Administrators - Full Control"
                - "Current location of Security.evtx is {{ wn16_au_000040_sec_log_location.stdout | trim }}"
                - "If the location of the logs has been changed, when adding Eventlog to the permissions,"
                - "it must be entered as NT Service\\Eventlog"
                - "{{ wn16_au_000040_sec_log_permissions.stdout_lines | reject('match', '^$') | list }}"

      - name: "MEDIUM | WN16-AU-000040 | AUDIT | Permissions for the Security event log must prevent access by non-privileged accounts. | Warning Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-AU-000040'
  when:
      - wn16_au_000040
  tags:
      - WN16-AU-000040
      - V-224878
      - SV-224878r569186_rule
      - SRG-OS-000057-GPOS-00027
      - CCI-000162
      - CCI-000163
      - CCI-000164
      - CAT2

- name: "MEDIUM | WN16-AU-000050 | AUDIT | Permissions for the System event log must prevent access by non-privileged accounts."
  block:
      - name: "MEDIUM | WN16-AU-000050 | AUDIT | Permissions for the System event log must prevent access by non-privileged accounts. | Get Default Log Locations."
        ansible.windows.win_shell: Get-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Services\EventLog\System\ | Select-Object File | ft -HideTableHeaders
        changed_when: false
        failed_when: false
        register: wn16_au_000050_system_log_location

      - name: "MEDIUM | WN16-AU-000050 | AUDIT | Permissions for the System event log must prevent access by non-privileged accounts. | Get Current Permissions For Default System Log."
        ansible.windows.win_shell: get-acl "{{ wn16_au_000050_system_log_location.stdout | trim }}" | FL AccessToString
        changed_when: false
        failed_when: false
        register: wn16_au_000050_system_log_permissions

      - name: "MEDIUM | WN16-AU-000050 | AUDIT | Permissions for the System event log must prevent access by non-privileged accounts. | Permissions warning for accounts."
        ansible.builtin.debug:
            msg:
                - "Warning!! Ensure the permissions on the System event log (System.evtx) are configured"
                - "to prevent standard user accounts or groups from having access. The default permissions listed below satisfy this requirement:"
                - "Eventlog - Full Control, SYSTEM - Full Control, Administrators - Full Control"
                - "Current location of System.evtx is {{ wn16_au_000050_system_log_location.stdout | trim }}"
                - "If the location of the logs has been changed, when adding Eventlog to the permissions,"
                - "it must be entered as NT Service\\Eventlog"
                - "{{ wn16_au_000050_system_log_permissions.stdout_lines | reject('match', '^$') | list }}"

      - name: "MEDIUM | WN16-AU-000050 | AUDIT | Permissions for the System event log must prevent access by non-privileged accounts. | Warning Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-AU-000050'
  when:
      - wn16_au_000050
  tags:
      - WN16-AU-000040
      - V-224879
      - SV-224879r569186_rule
      - SRG-OS-000057-GPOS-00027
      - CCI-000162
      - CCI-000163
      - CCI-000164
      - CAT2

- name: "MEDIUM | WN16-AU-000060 | AUDIT | Event Viewer must be protected from unauthorized modification and deletion."
  block:
      - name: "MEDIUM | WN16-AU-000060 | AUDIT | Event Viewer must be protected from unauthorized modification and deletion. | Get Current Permissions For Eventvwr.exe."
        ansible.windows.win_shell: get-acl {{ item }}:\Windows\system32\Eventvwr.exe | FL AccessToString
        changed_when: false
        failed_when: false
        with_items:
            - "{{ wn16_drive_letters.stdout_lines }}"
        register: wn16_au_000060_event_viewer_permissions

      - name: "MEDIUM | WN16-AU-000060 | AUDIT | Event Viewer must be protected from unauthorized modification and deletion. | Permissions warning for accounts."
        ansible.builtin.debug:
            msg:
                - "Warning!! Event Viewer must be protected from unauthorized modification and deletion."
                - "If any groups or accounts other than TrustedInstaller have Full control or Modify permissions, this is a finding."
                - "TrustedInstaller - Full Control, Administrators, SYSTEM, Users, ALL APPLICATION PACKAGES,"
                - "ALL RESTRICTED APPLICATION PACKAGES - Read & Execute"
                - "If there is no output below If the location of the logs has been changed"
                - "The default location should be System32 folder."
                - "{{ wn16_au_000060_event_viewer_permissions.results[0].stdout_lines }}"

      - name: "MEDIUM | WN16-AU-000060 | AUDIT | Event Viewer must be protected from unauthorized modification and deletion. | Warning Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-AU-000060'
  when:
      - wn16_au_000060
  tags:
      - WN16-AU-000060
      - V-224880
      - SV-224880r569186_rule
      - SRG-OS-000257-GPOS-00098
      - CCI-001494
      - CCI-001495
      - CAT2

- name: "MEDIUM | WN16-AU-000070 | PATCH | Windows Server 2016 must be configured to audit Account Logon - Credential Validation successes."
  block:
      - name: "MEDIUM | WN16-AU-000070 | AUDIT | Windows Server 2016 must be configured to audit Account Logon - Credential Validation successes. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Credential Validation" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000070_audit

      - name: "MEDIUM | WN16-AU-000070 | PATCH | Windows Server 2016 must be configured to audit Account Logon - Credential Validation successes. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Credential Validation" /success:enable
        when: "'Success' not in wn16_au_000070_audit.stdout"
  when:
      - wn16_au_000070
  tags:
      - WN16-AU-000070
      - V-224881
      - SV-224881r569186_rule
      - SRG-OS-000470-GPOS-00214
      - CCI-000172
      - CAT2

- name: "MEDIUM | WN16-AU-000080 | PATCH | Windows Server 2016 must be configured to audit Account Logon - Credential Validation failures. | Get Current Setting"
  block:
      - name: "MEDIUM | WN16-AU-000080 | AUDIT | Windows Server 2016 must be configured to audit Account Logon - Credential Validation failures."
        ansible.windows.win_shell: AuditPol /get /subcategory:"Credential Validation" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000080_audit

      - name: "MEDIUM | WN16-AU-000080 | PATCH | Windows Server 2016 must be configured to audit Account Logon - Credential Validation failures. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Credential Validation" /failure:enable
        when: "'Failure' not in wn16_au_000080_audit.stdout"
  when:
      - wn16_au_000080
  tags:
      - WN16-AU-000080
      - V-224882
      - SV-224882r569186_rule
      - SRG-OS-000470-GPOS-00214
      - CCI-000172
      - CAT2

- name: "MEDIUM | WN16-AU-000100 | PATCH | Windows Server 2016 must be configured to audit Account Management - Other Account Management Events successes."
  block:
      - name: "MEDIUM | WN16-AU-000100 | AUDIT | Windows Server 2016 must be configured to audit Account Management - Other Account Management Events successes. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Other Account Management Events" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000100_audit

      - name: "MEDIUM | WN16-AU-000100 | PATCH | Windows Server 2016 must be configured to audit Account Management - Other Account Management Events successes. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Other Account Management Events" /success:enable
        when: "'Success' not in wn16_au_000100_audit.stdout"
  when:
      - wn16_au_000100
  tags:
      - WN16-AU-000100
      - V-224883
      - SV-224883r852305_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN16-AU-000120 | PATCH | Windows Server 2016 must be configured to audit Account Management - Security Group Management successes."
  block:
      - name: "MEDIUM | WN16-AU-000120 | AUDIT | Windows Server 2016 must be configured to audit Account Management - Security Group Management successes. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Security Group Management" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000120_audit

      - name: "MEDIUM | WN16-AU-000120 | PATCH | Windows Server 2016 must be configured to audit Account Management - Security Group Management successes. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Security Group Management" /success:enable
        when: "'Success' not in wn16_au_000120_audit.stdout"
  when:
      - wn16_au_000120
  tags:
      - WN16-AU-000120
      - V-224884
      - SV-224884r852306_rule
      - SRG-OS-000004-GPOS-00004
      - CCI-000018
      - CCI-000172
      - CCI-001403
      - CCI-001404
      - CCI-001405
      - CCI-002130
      - CAT2

- name: "MEDIUM | WN16-AU-000140 | PATCH | Windows Server 2016 must be configured to audit Account Management - User Account Management successes."
  block:
      - name: "MEDIUM | WN16-AU-000140 | AUDIT | Windows Server 2016 must be configured to audit Account Management - User Account Management successes. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"User Account Management" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000140_audit

      - name: "MEDIUM | WN16-AU-000140 | PATCH | Windows Server 2016 must be configured to audit Account Management - User Account Management successes. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"User Account Management" /success:enable
        when: "'Success' not in wn16_au_000140_audit.stdout"
  when:
      - wn16_au_000140
  tags:
      - WN16-AU-000140
      - V-224885
      - SV-224885r852307_rule
      - SRG-OS-000004-GPOS-00004
      - CCI-000018
      - CCI-000172
      - CCI-001403
      - CCI-001404
      - CCI-001405
      - CCI-002130
      - CAT2

- name: "MEDIUM | WN16-AU-000150 | PATCH | Windows Server 2016 must be configured to audit Account Management - User Account Management failures."
  block:
      - name: "MEDIUM | WN16-AU-000150 | AUDIT | Windows Server 2016 must be configured to audit Account Management - User Account Management failures. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"User Account Management" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000150_audit

      - name: "MEDIUM | WN16-AU-000150 | PATCH | Windows Server 2016 must be configured to audit Account Management - User Account Management failures. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"User Account Management" /failure:enable
        when: "'Failure' not in wn16_au_000150_audit.stdout"
  when:
      - wn16_au_000150
  tags:
      - WN16-AU-000150
      - V-224886
      - SV-224886r852308_rule
      - SRG-OS-000004-GPOS-00004
      - CCI-000018
      - CCI-000172
      - CCI-001403
      - CCI-001404
      - CCI-001405
      - CCI-002130
      - CAT2

- name: "MEDIUM | WN16-AU-000160 | PATCH | Windows Server 2016 must be configured to audit Detailed Tracking - Plug and Play Events successes."
  block:
      - name: "MEDIUM | WN16-AU-000160 | AUDIT | Windows Server 2016 must be configured to audit Detailed Tracking - Plug and Play Events successes. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Plug and Play Events" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000160_audit

      - name: "MEDIUM | WN16-AU-000160 | PATCH | Windows Server 2016 must be configured to audit Detailed Tracking - Plug and Play Events successes. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Plug and Play Events" /success:enable
        when: "'Success' not in wn16_au_000160_audit.stdout"
  when:
      - wn16_au_000160
  tags:
      - WN16-AU-000160
      - V-224887
      - SV-224887r569186_rule
      - SRG-OS-000474-GPOS-00219
      - CCI-000172
      - CAT2

- name: "MEDIUM | WN16-AU-000170 | PATCH | Windows Server 2016 must be configured to audit Detailed Tracking - Process Creation successes."
  block:
      - name: "MEDIUM | WN16-AU-000170 | AUDIT | Windows Server 2016 must be configured to audit Detailed Tracking - Process Creation successes. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Process Creation" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000170_audit

      - name: "MEDIUM | WN16-AU-000170 | PATCH | Windows Server 2016 must be configured to audit Detailed Tracking - Process Creation successes. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Process Creation" /success:enable
        when: "'Success' not in wn16_au_000170_audit.stdout"
  when:
      - wn16_au_000170
  tags:
      - WN16-AU-000170
      - V-224888
      - SV-224888r852309_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CAT2

- name: "MEDIUM | WN16-AU-000230 | PATCH | Windows Server 2016 must be configured to audit Logon/Logoff - Account Lockout failures."
  block:
      - name: "MEDIUM | WN16-AU-000230 | AUDIT | Windows Server 2016 must be configured to audit Logon/Logoff - Account Lockout failures. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Account Lockout" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000230_audit

      - name: "MEDIUM | WN16-AU-000230 | PATCH | Windows Server 2016 must be configured to audit Logon/Logoff - Account Lockout failures. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Account Lockout" /failure:enable
        when: "'Failure' not in wn16_au_000230_audit.stdout"
  when:
      - wn16_au_000230
  tags:
      - WN16-AU-000230
      - V-224890
      - SV-224890r569186_rule
      - SRG-OS-000240-GPOS-00090
      - CCI-000172
      - CCI-001404
      - CAT2

- name: "MEDIUM | WN16-AU-000240 | PATCH | Windows Server 2016 must be configured to audit Logon/Logoff - Group Membership successes."
  block:
      - name: "MEDIUM | WN16-AU-000240 | AUDIT | Windows Server 2016 must be configured to audit Logon/Logoff - Group Membership successes. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Group Membership" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000240_audit

      - name: "MEDIUM | WN16-AU-000240 | PATCH | Windows Server 2016 must be configured to audit Logon/Logoff - Group Membership successes. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Group Membership" /success:enable
        when: "'Success' not in wn16_au_000240_audit.stdout"
  when:
      - wn16_au_000240
  tags:
      - WN16-AU-000240
      - V-224891
      - SV-224891r569186_rule
      - SRG-OS-000470-GPOS-00214
      - CCI-000172
      - CAT2

- name: "MEDIUM | WN16-AU-000250 | PATCH | Windows Server 2016 must be configured to audit Logon/Logoff - Logoff successes."
  block:
      - name: "MEDIUM | WN16-AU-000250 | AUDIT | Windows Server 2016 must be configured to audit Logon/Logoff - Logoff successes. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Logoff" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000250_audit

      - name: "MEDIUM | WN16-AU-000250 | PATCH | Windows Server 2016 must be configured to audit Logon/Logoff - Logoff successes. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Logoff" /success:enable
        when: "'Success' not in wn16_au_000250_audit.stdout"
  when:
      - wn16_au_000250
  tags:
      - WN16-AU-000250
      - V-224892
      - SV-224892r569186_rule
      - SRG-OS-000032-GPOS-00013
      - CCI-000067
      - CCI-000172
      - CAT2

- name: "MEDIUM | WN16-AU-000260 | PATCH | Windows Server 2016 must be configured to audit Logon/Logoff - Logon successes."
  block:
      - name: "MEDIUM | WN16-AU-000260 | AUDIT | Windows Server 2016 must be configured to audit Logon/Logoff - Logon successes. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Logon" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000260_audit

      - name: "MEDIUM | WN16-AU-000260 | PATCH | Windows Server 2016 must be configured to audit Logon/Logoff - Logon successes. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Logon" /success:enable
        when: "'Success' not in wn16_au_000260_audit.stdout"
  when:
      - wn16_au_000260
  tags:
      - WN16-AU-000260
      - V-224893
      - SV-224893r569186_rule
      - SRG-OS-000032-GPOS-00013
      - CCI-000067
      - CCI-000172
      - CAT2

- name: "MEDIUM | WN16-AU-000270 | PATCH | Windows Server 2016 must be configured to audit Logon/Logoff - Logon failures."
  block:
      - name: "MEDIUM | WN16-AU-000270 | AUDIT | Windows Server 2016 must be configured to audit Logon/Logoff - Logon failures. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Logon" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000270_audit

      - name: "MEDIUM | WN16-AU-000270 | PATCH | Windows Server 2016 must be configured to audit Logon/Logoff - Logon failures. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Logon" /failure:enable
        when: "'Failure' not in wn16_au_000270_audit.stdout"
  when:
      - wn16_au_000270
  tags:
      - WN16-AU-000270
      - V-224894
      - SV-224894r569186_rule
      - SRG-OS-000032-GPOS-00013
      - CCI-000067
      - CCI-000172
      - CAT2

- name: "MEDIUM | WN16-AU-000280 | PATCH | Windows Server 2016 must be configured to audit Logon/Logoff - Special Logon successes."
  block:
      - name: "MEDIUM | WN16-AU-000280 | AUDIT | Windows Server 2016 must be configured to audit Logon/Logoff - Special Logon successes. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Special Logon" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000280_audit

      - name: "MEDIUM | WN16-AU-000280 | PATCH | Windows Server 2016 must be configured to audit Logon/Logoff - Special Logon successes. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Special Logon" /success:enable
        when: "'Success' not in wn16_au_000280_audit.stdout"
  when:
      - wn16_au_000280
  tags:
      - WN16-AU-000280
      - V-224895
      - SV-224895r569186_rule
      - SRG-OS-000470-GPOS-00214
      - CCI-000172
      - CAT2

- name: |
      "MEDIUM | WN16-AU-000285 | PATCH | Windows 2016 must be configured to audit Object Access - Other Object Access Events successes."
      "MEDIUM | WN16-AU-000286 | PATCH | Windows 2016 must be configured to audit Object Access - Other Object Access Events failures."
  community.windows.win_audit_policy_system:
      subcategory: Other Object Access Events
      audit_type: success, failure
  when:
      - wn16_au_000285 or
        wn16_au_000286
  tags:
      - WN16-AU-000285
      - WN16-AU-000286
      - V-224896
      - V-224897
      - SV-224896r569186_rule
      - SV-224897r569186_rule
      - SRG-OS-000470-GPOS-00214
      - CCI-000172
      - CAT2

- name: "MEDIUM | WN16-AU-000290 | PATCH | Windows Server 2016 must be configured to audit Object Access - Removable Storage successes."
  block:
      - name: "MEDIUM | WN16-AU-000290 | AUDIT | Windows Server 2016 must be configured to audit Object Access - Removable Storage successes. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Removable Storage" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000290_audit

      - name: "MEDIUM | WN16-AU-000290 | PATCH | Windows Server 2016 must be configured to audit Object Access - Removable Storage successes. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Removable Storage" /success:enable
        when: "'Success' not in wn16_au_000290_audit.stdout"
  when:
      - wn16_au_000290
  tags:
      - WN16-AU-000290
      - V-224898
      - SV-224898r569186_rule
      - SRG-OS-000474-GPOS-00219
      - CCI-000172
      - CAT2

- name: "MEDIUM | WN16-AU-000300 | PATCH | Windows Server 2016 must be configured to audit Object Access - Removable Storage failures."
  block:
      - name: "MEDIUM | WN16-AU-000300 | AUDIT | Windows Server 2016 must be configured to audit Object Access - Removable Storage failures. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Removable Storage" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000300_audit

      - name: "MEDIUM | WN16-AU-000300 | PATCH | Windows Server 2016 must be configured to audit Object Access - Removable Storage failures. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Removable Storage" /failure:enable
        when: "'Failure' not in wn16_au_000300_audit.stdout"
  when:
      - wn16_au_000300
  tags:
      - WN16-AU-000300
      - V-224899
      - SV-224899r569186_rule
      - SRG-OS-000474-GPOS-00219
      - CCI-000172
      - CAT2

- name: "MEDIUM | WN16-AU-000310 | PATCH | Windows Server 2016 must be configured to audit Policy Change - Audit Policy Change successes."
  block:
      - name: "MEDIUM | WN16-AU-000310 | AUDIT | Windows Server 2016 must be configured to audit Policy Change - Audit Policy Change successes. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Audit Policy Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000310_audit

      - name: "MEDIUM | WN16-AU-000310 | PATCH | Windows Server 2016 must be configured to audit Policy Change - Audit Policy Change successes. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Audit Policy Change" /success:enable
        when: "'Success' not in wn16_au_000310_audit.stdout"
  when:
      - wn16_au_000310
  tags:
      - WN16-AU-000310
      - V-224900
      - SV-224900r852310_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN16-AU-000320 | PATCH | Windows Server 2016 must be configured to audit Policy Change - Audit Policy Change failures."
  block:
      - name: "MEDIUM | WN16-AU-000320 | AUDIT | Windows Server 2016 must be configured to audit Policy Change - Audit Policy Change failures. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Audit Policy Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000320_audit

      - name: "MEDIUM | WN16-AU-000320 | PATCH | Windows Server 2016 must be configured to audit Policy Change - Audit Policy Change failures. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Audit Policy Change" /failure:enable
        when: "'Failure' not in wn16_au_000320_audit.stdout"
  when:
      - wn16_au_000320
  tags:
      - WN16-AU-000320
      - V-224901
      - SV-224901r852311_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN16-AU-000330 | PATCH | Windows Server 2016 must be configured to audit Policy Change - Authentication Policy Change successes."
  block:
      - name: "MEDIUM | WN16-AU-000330 | AUDIT | Windows Server 2016 must be configured to audit Policy Change - Authentication Policy Change successes. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Authentication Policy Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000330_audit

      - name: "MEDIUM | WN16-AU-000330 | PATCH | Windows Server 2016 must be configured to audit Policy Change - Authentication Policy Change successes. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Authentication Policy Change" /success:enable
        when: "'Success' not in wn16_au_000330_audit.stdout"
  when:
      - wn16_au_000330
  tags:
      - WN16-AU-000330
      - V-224902
      - SV-224902r852312_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN16-AU-000340 | PATCH | Windows Server 2016 must be configured to audit Policy Change - Authorization Policy Change successes."
  block:
      - name: "MEDIUM | WN16-AU-000340 | AUDIT | Windows Server 2016 must be configured to audit Policy Change - Authorization Policy Change successes. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Authorization Policy Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000340_audit

      - name: "MEDIUM | WN16-AU-000340 | PATCH | Windows Server 2016 must be configured to audit Policy Change - Authorization Policy Change successes. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Authorization Policy Change" /success:enable
        when: "'Success' not in wn16_au_000340_audit.stdout"
  when:
      - wn16_au_000340
  tags:
      - WN16-AU-000340
      - V-224903
      - SV-224903r852313_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN16-AU-000350 | PATCH | Windows Server 2016 must be configured to audit Privilege Use - Sensitive Privilege Use successes."
  block:
      - name: "MEDIUM | WN16-AU-000350 | AUDIT | Windows Server 2016 must be configured to audit Privilege Use - Sensitive Privilege Use successes. | Get Current Settings"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Sensitive Privilege Use" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000350_audit

      - name: "MEDIUM | WN16-AU-000350 | PATCH | Windows Server 2016 must be configured to audit Privilege Use - Sensitive Privilege Use successes. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Sensitive Privilege Use" /success:enable
        when:
            - "'Success' not in wn16_au_000350_audit.stdout"
  when:
      - wn16_au_000350
  tags:
      - WN16-AU-000350
      - V-224904
      - SV-224904r852314_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN16-AU-000360 | PATCH | Windows Server 2016 must be configured to audit Privilege Use - Sensitive Privilege Use failures."
  block:
      - name: "MEDIUM | WN16-AU-000360 | AUDIT | Windows Server 2016 must be configured to audit Privilege Use - Sensitive Privilege Use failures. | Get Current Settings"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Sensitive Privilege Use" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000360_audit

      - name: "MEDIUM | WN16-AU-000360 | PATCH | Windows Server 2016 must be configured to audit Privilege Use - Sensitive Privilege Use failures. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Sensitive Privilege Use" /failure:enable
        when: "'Failure' not in wn16_au_000360_audit.stdout"
  when:
      - wn16_au_000360
  tags:
      - WN16-AU-000360
      - V-224905
      - SV-224905r852315_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN16-AU-000370 | PATCH | Windows Server 2016 must be configured to audit System - IPsec Driver successes."
  block:
      - name: "MEDIUM | WN16-AU-000370 | AUDIT | Windows Server 2016 must be configured to audit System - IPsec Driver successes. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"IPsec Driver" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000370_audit

      - name: "MEDIUM | WN16-AU-000370 | PATCH | Windows Server 2016 must be configured to audit System - IPsec Driver successes. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"IPsec Driver" /success:enable
        when: "'Success' not in wn16_au_000370_audit.stdout"
  when:
      - wn16_au_000370
  tags:
      - WN16-AU-000370
      - V-224906
      - SV-224906r852316_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN16-AU-000380 | PATCH | Windows Server 2016 must be configured to audit System - IPsec Driver failures."
  block:
      - name: "MEDIUM | WN16-AU-000380 | AUDIT | Windows Server 2016 must be configured to audit System - IPsec Driver failures. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"IPsec Driver" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000380_audit

      - name: "MEDIUM | WN16-AU-000380 | PATCH | Windows Server 2016 must be configured to audit System - IPsec Driver failures. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"IPsec Driver" /failure:enable
        when: "'Failure' not in wn16_au_000380_audit.stdout"
  when:
      - wn16_au_000380
  tags:
      - WN16-AU-000380
      - V-224907
      - SV-224907r852317_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN16-AU-000390 | PATCH | Windows Server 2016 must be configured to audit System - Other System Events successes."
  block:
      - name: "MEDIUM | WN16-AU-000390 | AUDIT | Windows Server 2016 must be configured to audit System - Other System Events successes. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Other System Events" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000390_audit

      - name: "MEDIUM | WN16-AU-000390 | PATCH | Windows Server 2016 must be configured to audit System - Other System Events successes. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Other System Events" /success:enable
        when: "'Success' not in wn16_au_000390_audit.stdout"
  when:
      - wn16_au_000390
  tags:
      - WN16-AU-000390
      - V-224908
      - SV-224908r852318_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN16-AU-000400 | PATCH | Windows Server 2016 must be configured to audit System - Other System Events failures."
  block:
      - name: "MEDIUM | WN16-AU-000400 | AUDIT | Windows Server 2016 must be configured to audit System - Other System Events failures. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Other System Events" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000400_audit

      - name: "MEDIUM | WN16-AU-000400 | PATCH | Windows Server 2016 must be configured to audit System - Other System Events failures. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Other System Events" /failure:enable
        when: "'Failure' not in wn16_au_000400_audit.stdout"
  when:
      - wn16_au_000400
  tags:
      - WN16-AU-000400
      - V-224909
      - SV-224909r852319_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN16-AU-000410 | PATCH | Windows Server 2016 must be configured to audit System - Security State Change successes."
  block:
      - name: "MEDIUM | WN16-AU-000410 | AUDIT | Windows Server 2016 must be configured to audit System - Security State Change successes. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Security State Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000410_audit

      - name: "MEDIUM | WN16-AU-000410 | PATCH | Windows Server 2016 must be configured to audit System - Security State Change successes. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Security State Change" /success:enable
        when: "'Success' not in wn16_au_000410_audit.stdout"
  when:
      - wn16_au_000410
  tags:
      - WN16-AU-000410
      - V-224910
      - SV-224910r852320_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN16-AU-000420 | PATCH | Windows Server 2016 must be configured to audit System - Security System Extension successes."
  block:
      - name: "MEDIUM | WN16-AU-000420 | AUDIT | Windows Server 2016 must be configured to audit System - Security System Extension successes. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Security System Extension" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000420_audit

      - name: "MEDIUM | WN16-AU-000420 | PATCH | Windows Server 2016 must be configured to audit System - Security System Extension successes. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Security System Extension" /success:enable
        when: "'Success' not in wn16_au_000420_audit.stdout"
  when:
      - wn16_au_000420
  tags:
      - WN16-AU-000420
      - V-224911
      - SV-224911r852321_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN16-AU-000440 | PATCH | Windows Server 2016 must be configured to audit System - System Integrity successes."
  block:
      - name: "MEDIUM | WN16-AU-000440 | AUDIT | Windows Server 2016 must be configured to audit System - System Integrity successes. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"System Integrity" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000440_audit

      - name: "MEDIUM | WN16-AU-000440 | PATCH | Windows Server 2016 must be configured to audit System - System Integrity successes. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"System Integrity" /success:enable
        when: "'Success' not in wn16_au_000440_audit.stdout"
  when:
      - wn16_au_000440
  tags:
      - WN16-AU-000440
      - V-224912
      - SV-224912r852322_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN16-AU-000450 | PATCH | Windows Server 2016 must be configured to audit System - System Integrity failures."
  block:
      - name: "MEDIUM | WN16-AU-000450 | AUDIT | Windows Server 2016 must be configured to audit System - System Integrity failures. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"System Integrity" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_au_000450_audit

      - name: "MEDIUM | WN16-AU-000450 | PATCH | Windows Server 2016 must be configured to audit System - System Integrity failures. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"System Integrity" /failure:enable
        when: "'Failure' not in wn16_au_000450_audit.stdout"
  when:
      - wn16_au_000450
  tags:
      - WN16-AU-000450
      - V-224913
      - SV-224913r852323_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002234
      - CAT2

# some versions may be core/no gui, may need a prelim to detect?
- name: "MEDIUM | WN16-CC-000010 | PATCH | The display of slide shows on the lock screen must be disabled."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Personalization
      state: present
      value: NoLockScreenSlideshow
      data: 1
      datatype: dword
  when:
      - wn16_cc_000010
  tags:
      - WN16-CC-000010
      - V-224914
      - SV-224914r569186_rule
      - SRG-OS-000095-GPOS-00049
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN16-CC-000030 | PATCH | WDigest Authentication must be disabled on Windows Server 2016."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\Wdigest
      state: present
      value: UseLogonCredential
      data: 0
      datatype: dword
  when:
      - wn16_cc_000030
  tags:
      - WN16-CC-000030
      - V-224915
      - SV-224915r569186_rule
      - SRG-OS-000095-GPOS-00049
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN16-CC-000080 | PATCH | Insecure logons to an SMB server must be disabled."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\LanmanWorkstation
      state: present
      value: AllowInsecureGuestAuth
      data: 0
      datatype: dword
  when:
      - wn16_cc_000080
  tags:
      - WN16-CC-000080
      - V-224920
      - SV-224920r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

# verify if this applies to DC or only MS?
- name: "MEDIUM | WN16-CC-000090 | PATCH | Hardened UNC paths must be defined to require mutual authentication and integrity for at least the SYSVOL and NETLOGON shares."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\NetworkProvider\HardenedPaths
      state: present
      value: "{{ item }}"
      data: RequireMutualAuthentication=1, RequireIntegrity=1
      datatype: string
  with_items:
      - \\*\SYSVOL
      - \\*\NETLOGON
  when:
      - wn16_cc_000090
      - ansible_windows_domain_member
  tags:
      - WN16-CC-000090
      - V-224921
      - SV-224921r857251_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-CC-000100 | PATCH | Command line data must be included in process creation events."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Audit
      state: present
      value: ProcessCreationIncludeCmdLine_Enabled
      data: 1
      datatype: dword
  when:
      - wn16_cc_000100
  tags:
      - WN16-CC-000100
      - V-224922
      - SV-224922r569186_rule
      - SRG-OS-000042-GPOS-00020
      - CCI-000135
      - CAT2

- name: "MEDIUM | WN16-CC-000110 | PATCH | Windows Server 2016 virtualization-based security must be enabled with the platform security level configured to Secure Boot or Secure Boot with DMA Protection."
  block:
      - name: "MEDIUM | WN16-CC-000110 | PATCH | Windows Server 2016 virtualization-based security must be enabled with the platform security level configured to Secure Boot or Secure Boot with DMA Protection. | EnableVirtualizationBasedSecurity Registry Add"
        ansible.windows.win_regedit:
            path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard\
            state: present
            value: EnableVirtualizationBasedSecurity
            data: 1
            datatype: dword

      - name: "MEDIUM | WN16-CC-000110 | PATCH | Windows Server 2016 virtualization-based security must be enabled with the platform security level configured to Secure Boot or Secure Boot with DMA Protection. | RequirePlatformSecurityFeatures Registry Add"
        ansible.windows.win_regedit:
            path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard\
            state: present
            value: RequirePlatformSecurityFeatures
            data: "{{ wn16stig_dma_protection }}"
            datatype: dword

      - name: "MEDIUM | WN16-CC-000110 | AUDIT | Windows Server 2016 virtualization-based security must be enabled with the platform security level configured to Secure Boot or Secure Boot with DMA Protection. | Get Status Of Device Guard Virtualization."
        ansible.windows.win_shell: Get-CimInstance -ClassName Win32_DeviceGuard -Namespace root\Microsoft\Windows\DeviceGuard | Select-Object VirtualizationBasedSecurityStatus | ft -hidetableheaders
        changed_when: false
        failed_when: false
        register: wn16_cc_000110_audit

      - name: "MEDIUM | WN16-CC-000110 | AUDIT | Windows Server 2016 virtualization-based security must be enabled with the platform security level configured to Secure Boot or Secure Boot with DMA Protection. | Device Guard Virtualization based security Not Running Warning Message."
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Windows Server 2016 virtualization-based security must be enabled with the platform security"
                - "level configured to Secure Boot or Secure Boot with DMA Protection. The policy settings referenced in the Fix section will"
                - "configure the following registry values. However, due to hardware requirements, the registry values alone do not ensure proper"
                - "function."
        when: "'2' not in wn16_cc_000110_audit.stdout | trim"

      - name: "MEDIUM | WN16-CC-000110 | AUDIT | Windows Server 2016 virtualization-based security must be enabled with the platform security level configured to Secure Boot or Secure Boot with DMA Protection. | Warn Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-CC-000110'
        when: "'2' not in wn16_cc_000110_audit.stdout | trim"
  when:
      - wn16_cc_000110
      - ansible_windows_domain_member
  tags:
      - WN16-CC-000110
      - V-224923
      - SV-224923r857253_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-CC-000140 | PATCH | Early Launch Antimalware, Boot-Start Driver Initialization Policy must prevent boot drivers identified as bad."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Policies\EarlyLaunch
      state: present
      value: DriverLoadPolicy
      data: "{{ wn16stig_driver_load_policy }}"
      datatype: dword
  when:
      - wn16_cc_000140
  tags:
      - WN16-CC-000140
      - V-224924
      - SV-224924r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-CC-000150 | PATCH | Group Policy objects must be reprocessed even if they have not changed."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Group Policy\{35378EAC-683F-11D2-A89A-00C04FBBCFA2}
      state: present
      value: NoGPOListChanges
      data: 0
      datatype: dword
  when:
      - wn16_cc_000150
  tags:
      - WN16-CC-000150
      - V-224925
      - SV-224925r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-CC-000160 | PATCH | Downloading print driver packages over HTTP must be prevented."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers
      state: present
      value: DisableWebPnPDownload
      data: 1
      datatype: dword
  when:
      - wn16_cc_000160
  tags:
      - WN16-CC-000160
      - V-224926
      - SV-224926r569186_rule
      - SRG-OS-000095-GPOS-00049
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN16-CC-000170 | PATCH | Printing over HTTP must be prevented."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers
      state: present
      value: DisableHTTPPrinting
      data: 1
      datatype: dword
  when:
      - wn16_cc_000170
  tags:
      - WN16-CC-000170
      - V-224947
      - SV-224947r877394_rule
      - SRG-OS-000250-GPOS-00093
      - CCI-001453
      - CAT2

- name: "MEDIUM | WN16-CC-000180 | PATCH | The network selection user interface (UI) must not be displayed on the logon screen."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\System
      state: present
      value: DontDisplayNetworkSelectionUI
      data: 1
      datatype: dword
  when:
      - wn16_cc_000180
  tags:
      - WN16-CC-000180
      - V-224928
      - SV-224928r569186_rule
      - SRG-OS-000095-GPOS-00049
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN16-CC-000210 | PATCH | Users must be prompted to authenticate when the system wakes from sleep (on battery)."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51
      state: present
      value: DCSettingIndex
      data: 1
      datatype: dword
  when:
      - wn16_cc_000210
  tags:
      - WN16-CC-000210
      - V-224929
      - SV-224929r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-CC-000220 | PATCH | Users must be prompted to authenticate when the system wakes from sleep (plugged in)."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51
      state: present
      value: ACSettingIndex
      data: 1
      datatype: dword
  when:
      - wn16_cc_000220
  tags:
      - WN16-CC-000220
      - V-224930
      - SV-224930r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-CC-000280 | PATCH | Administrator accounts must not be enumerated during elevation."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\CredUI
      state: present
      value: EnumerateAdministrators
      data: 0
      datatype: dword
  when:
      - wn16_cc_000280
  tags:
      - WN16-CC-000280
      - V-224935
      - SV-224935r569186_rule
      - SRG-OS-000134-GPOS-00068
      - CCI-001084
      - CAT2

- name: "MEDIUM | WN16-CC-000290 | PATCH | Windows Telemetry must be configured to Security or Basic."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection
      state: present
      value: AllowTelemetry
      data: 0
      datatype: dword
  when:
      - wn16_cc_000290
  tags:
      - WN16-CC-000290
      - V-224936
      - SV-224936r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-CC-000300 | PATCH | The Application event log size must be configured to 32768 KB or greater."
  block:
      - name: "MEDIUM | WN16-CC-000300 | AUDIT | The Application event log size must be configured to 32768 KB or greater. | Warning Message."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid file size set for wn16stig_application_event_log_max_size please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when: wn16stig_application_event_log_max_size < 32768

      - name: "MEDIUM | WN16-CC-000300 | AUDIT | The Application event log size must be configured to 32768 KB or greater. | Warning Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-CC-000300'
        when: wn16stig_application_event_log_max_size < 32768

      - name: "MEDIUM | WN16-CC-000300 | PATCH | The Application event log size must be configured to 32768 KB or greater. | Apply Log Size"
        ansible.windows.win_regedit:
            path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\Application
            state: present
            value: MaxSize
            data: "{{ wn16stig_application_event_log_max_size }}"
            datatype: dword
        when: wn16stig_application_event_log_max_size >= 32768
  when:
      - wn16_cc_000300
  tags:
      - WN16-CC-000300
      - V-224937
      - SV-224937r877391_rule
      - SRG-OS-000341-GPOS-00132
      - CCI-001849
      - CAT2

- name: "MEDIUM | WN16-CC-000310 | PATCH | The Security event log size must be configured to 196608 KB or greater."
  block:
      - name: "MEDIUM | WN16-CC-000310 | AUDIT | The Security event log size must be configured to 196608 KB or greater. | Warning Message."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid file size set for wn16stig_security_event_log_size please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when: wn16stig_security_event_log_max_size < 196608

      - name: "MEDIUM | WN16-CC-000310 | AUDIT | The Security event log size must be configured to 196608 KB or greater. | Warning Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-CC-000310'
        when: wn16stig_security_event_log_max_size < 196608

      - name: "MEDIUM | WN16-CC-000310 | PATCH | The Security event log size must be configured to 196608 KB or greater. | Apply Log Size"
        ansible.windows.win_regedit:
            path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\Security
            state: present
            value: MaxSize
            data: "{{ wn16stig_security_event_log_max_size }}"
            datatype: dword
        when: wn16stig_security_event_log_max_size >= 196608
  when:
      - wn16_cc_000310
  tags:
      - WN16-CC-000310
      - V-224938
      - SV-224938r877391_rule
      - SRG-OS-000341-GPOS-00132
      - CCI-001849
      - CAT2

- name: "MEDIUM | WN16-CC-000320 | PATCH | The System event log size must be configured to 32768 KB or greater."
  block:
      - name: "MEDIUM | WN16-CC-000320 | AUDIT | The System event log size must be configured to 32768 KB or greater. | Warning Message."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid file size set for wn16stig_system_event_log_max_size please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when: wn16stig_system_event_log_max_size < 32768

      - name: "MEDIUM | WN16-CC-000320 | AUDIT | The System event log size must be configured to 32768 KB or greater. | Warning Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-CC-000320'
        when: wn16stig_system_event_log_max_size < 32768

      - name: "MEDIUM | WN16-CC-000320 | PATCH | The System event log size must be configured to 32768 KB or greater. | Apply Log Size"
        ansible.windows.win_regedit:
            path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\System
            state: present
            value: MaxSize
            data: "{{ wn16stig_system_event_log_max_size }}"
            datatype: dword
        when: wn16stig_system_event_log_max_size >= 32768
  when:
      - wn16_cc_000320
  tags:
      - WN16-CC-000320
      - V-224939
      - SV-224939r877391_rule
      - SRG-OS-000341-GPOS-00132
      - CCI-001849
      - CAT2

- name: "MEDIUM | WN16-CC-000330 | PATCH | Windows Server 2016 Windows SmartScreen must be enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\System
      state: present
      value: EnableSmartScreen
      data: 1
      datatype: dword
  when:
      - wn16_cc_000330
  tags:
      - WN16-CC-000330
      - V-224940
      - SV-224940r569186_rule
      - SRG-OS-000095-GPOS-00049
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN16-CC-000340 | PATCH | Explorer Data Execution Prevention must be enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Explorer
      state: present
      value: NoDataExecutionPrevention
      data: 0
      datatype: dword
  when:
      - wn16_cc_000340
  tags:
      - WN16-CC-000340
      - V-224941
      - SV-224941r852331_rule
      - SRG-OS-000433-GPOS-00192
      - CCI-002824
      - CAT2

- name: "MEDIUM | WN16-CC-000360 | PATCH | File Explorer shell protocol must run in protected mode."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer
      state: present
      value: PreXPSP2ShellProtocolBehavior
      data: 0
      datatype: dword
  when:
      - wn16_cc_000360
  tags:
      - WN16-CC-000360
      - V-224943
      - SV-224943r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-CC-000370 | PATCH | Passwords must not be saved in the Remote Desktop Client."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services
      state: present
      value: DisablePasswordSaving
      data: 1
      datatype: dword
  when:
      - wn16_cc_000370
  tags:
      - WN16-CC-000370
      - V-224944
      - SV-224944r852332_rule
      - SRG-OS-000373-GPOS-00157
      - CCI-002038
      - CAT2

- name: "MEDIUM | WN16-CC-000380 | PATCH | Local drives must be prevented from sharing with Remote Desktop Session Hosts."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services
      state: present
      value: fDisableCdm
      data: 1
      datatype: dword
  when:
      - wn16_cc_000380
  tags:
      - WN16-CC-000380
      - V-224945
      - SV-224945r569186_rule
      - SRG-OS-000138-GPOS-00069
      - CCI-001090
      - CAT2

- name: "MEDIUM | WN16-CC-000390 | PATCH | Remote Desktop Services must always prompt a client for passwords upon connection."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services
      state: present
      value: fPromptForPassword
      data: 1
      datatype: dword
  when:
      - wn16_cc_000390
  tags:
      - WN16-CC-000390
      - V-224946
      - SV-224946r852333_rule
      - SRG-OS-000373-GPOS-00157
      - CCI-002038
      - CAT2

- name: "MEDIUM | WN16-CC-000400 | PATCH | The Remote Desktop Session Host must require secure Remote Procedure Call (RPC) communications."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services
      state: present
      value: fEncryptRPCTraffic
      data: 1
      datatype: dword
  when:
      - wn16_cc_000400
  tags:
      - WN16-CC-000400
      - V-224947
      - SV-224947r877394_rule
      - SRG-OS-000250-GPOS-00093
      - CCI-001453
      - CAT2

- name: "MEDIUM | WN16-CC-000410 | PATCH | Remote Desktop Services must be configured with the client connection encryption set to High Level."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services
      state: present
      value: MinEncryptionLevel
      data: 3
      datatype: dword
  when:
      - wn16_cc_000410
  tags:
      - WN16-CC-000410
      - V-224948
      - SV-224948r877394_rule
      - SRG-OS-000250-GPOS-00093
      - CCI-001453
      - CAT2

- name: "MEDIUM | WN16-CC-000420 | PATCH | Attachments must be prevented from being downloaded from RSS feeds."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Internet Explorer\Feeds
      state: present
      value: DisableEnclosureDownload
      data: 1
      datatype: dword
  when:
      - wn16_cc_000420
  tags:
      - WN16-CC-000420
      - V-224949
      - SV-224949r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-CC-000430 | PATCH | Basic authentication for RSS feeds over HTTP must not be used."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Internet Explorer\Feeds
      state: present
      value: AllowBasicAuthInClear
      data: 0
      datatype: dword
  when:
      - wn16_cc_000430
  tags:
      - WN16-CC-000430
      - V-224951
      - SV-224951r569186_rule
      - SRG-OS-000095-GPOS-00049
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN16-CC-000440 | PATCH | Indexing of encrypted files must be turned off."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Search
      state: present
      value: AllowIndexingEncryptedStoresOrItems
      data: 0
      datatype: dword
  when:
      - wn16_cc_000440
  tags:
      - WN16-CC-000440
      - V-224952
      - SV-224952r569186_rule
      - SRG-OS-000095-GPOS-00049
      - SRG-OS-000095-GPOS-00049
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN16-CC-000450 | PATCH | Users must be prevented from changing installation options."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Installer
      state: present
      value: EnableUserControl
      data: 0
      datatype: dword
  when:
      - wn16_cc_000450
  tags:
      - WN16-CC-000450
      - V-224953
      - SV-224953r852334_rule
      - SRG-OS-000362-GPOS-00149
      - CCI-001812
      - CAT2

- name: "MEDIUM | WN16-CC-000470 | PATCH | Users must be notified if a web-based program attempts to install software."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Installer
      state: present
      value: SafeForScripting
      data: 0
      datatype: dword
  when:
      - wn16_cc_000470
  tags:
      - WN16-CC-000470
      - V-224955
      - SV-224955r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-CC-000480 | PATCH | Automatically signing in the last interactive user after a system-initiated restart must be disabled."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      state: present
      value: DisableAutomaticRestartSignOn
      data: 1
      datatype: dword
  when:
      - wn16_cc_000480
  tags:
      - WN16-CC-000480
      - V-224956
      - SV-224956r877377_rule
      - SRG-OS-000480-GPOS-00229
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-CC-000490 | PATCH | PowerShell script block logging must be enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging
      state: present
      value: EnableScriptBlockLogging
      data: 1
      datatype: dword
  when:
      - wn16_cc_000490
  tags:
      - WN16-CC-000490
      - V-224957
      - SV-224957r569186_rule
      - SRG-OS-000042-GPOS-00020
      - CCI-000135
      - CAT2

- name: "MEDIUM | WN16-CC-000510 | PATCH | The Windows Remote Management (WinRM) client must not allow unencrypted traffic."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Client
      state: present
      value: AllowUnencryptedTraffic
      data: 0
      datatype: dword
  when:
      - wn16_cc_000510
      - not win_skip_for_test
  tags:
      - WN16-CC-000510
      - V-224959
      - SV-224959r877382_rule
      - SRG-OS-000393-GPOS-00173
      - CCI-002890
      - CCI-003123
      - CAT2

- name: "MEDIUM | WN16-CC-000520 | PATCH | The Windows Remote Management (WinRM) client must not use Digest authentication."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Client
      state: present
      value: AllowDigest
      data: 0
      datatype: dword
  when:
      - wn16_cc_000520
      - not win_skip_for_test
  tags:
      - WN16-CC-000520
      - V-224960
      - SV-224960r877395_rule
      - SRG-OS-000125-GPOS-00065
      - CCI-000877
      - CAT2

- name: "MEDIUM | WN16-CC-000540 | PATCH | The Windows Remote Management (WinRM) service must not allow unencrypted traffic."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Service
      state: present
      value: AllowUnencryptedTraffic
      data: 0
      datatype: dword
  when:
      - wn16_cc_000540
      - not win_skip_for_test
  tags:
      - WN16-CC-000540
      - V-224962
      - SV-224962r877382_rule
      - SRG-OS-000393-GPOS-00173
      - CCI-002890
      - CCI-003123
      - CAT2

- name: "MEDIUM | WN16-CC-000550 | PATCH | The Windows Remote Management (WinRM) service must not store RunAs credentials."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Service
      state: present
      value: DisableRunAs
      data: 1
      datatype: dword
  when:
      - wn16_cc_000550
      - not win_skip_for_test
  tags:
      - WN16-CC-000550
      - V-224963
      - SV-224963r852338_rule
      - SRG-OS-000373-GPOS-00157
      - CCI-002038
      - CAT2

- name: "MEDIUM | WN16-DC-000020 | AUDIT | Kerberos user logon restrictions must be enforced."
  block:
      - name: "MEDIUM | WN16-DC-000020 | AUDIT | Kerberos user logon restrictions must be enforced. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! Kerberos user logon restrictions must be enforced."
                - "Configure the policy value in the Default Domain Policy for Computer Configuration"
                - ">> Policies >> Windows Settings >> Security Settings >> Account Policies >> Kerberos Policy"
                - ">> Enforce user logon restrictions to Enabled"

      - name: "MEDIUM | WN16-DC-000020 | AUDIT | Kerberos user logon restrictions must be enforced. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-DC-000020'
  when:
      - wn16_dc_000020
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000020
      - V-224965
      - SV-224965r852340_rule
      - SRG-OS-000112-GPOS-00057
      - CCI-001941
      - CCI-001942
      - CAT2

- name: "MEDIUM | WN16-DC-000030 | AUDIT | The Kerberos service ticket maximum lifetime must be limited to 600 minutes or less."
  block:
      - name: "MEDIUM | WN16-DC-000030 | AUDIT | The Kerberos service ticket maximum lifetime must be limited to 600 minutes or less. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! The Kerberos service ticket maximum lifetime must be limited to 600 minutes or less."
                - "Configure the policy value in the Default Domain Policy for Computer Configuration"
                - ">> Policies >> Windows Settings >> Security Settings >> Account Policies >> Kerberos Policy"
                - ">> Maximum lifetime for service ticket to a maximum of 600 minutes, but not 0, which equates to"
                - "Ticket doesn't expire"

      - name: "MEDIUM | WN16-DC-000030 | AUDIT | The Kerberos service ticket maximum lifetime must be limited to 600 minutes or less. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-DC-000030'
  when:
      - wn16_dc_000030
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000030
      - V-224966
      - SV-224966r852341_rule
      - SRG-OS-000112-GPOS-00057
      - CCI-001941
      - CCI-001942
      - CAT2

- name: "MEDIUM | WN16-DC-000040 | AUDIT | Kerberos user ticket lifetime must be limited to 10 hours or less."
  block:
      - name: "MEDIUM | WN16-DC-000040 | AUDIT | The Kerberos user ticket lifetime must be limited to 10 hours or less. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! The Kerberos user ticket lifetime must be limited to 10 hours or less."
                - "Configure the policy value in the Default Domain Policy for Computer Configuration"
                - ">> Policies >> Windows Settings >> Security Settings >> Account Policies >> Kerberos Policy"
                - ">> Maximum lifetime for user ticket to a maximum of 10 hours but not 0, which equates to Ticket doesn't expire"

      - name: "MEDIUM | WN16-DC-000040 | AUDIT | The Kerberos user ticket lifetime must be limited to 10 hours or less. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-DC-000040'
  when:
      - wn16_dc_000040
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000040
      - V-224967
      - SV-224967r852342_rule
      - SRG-OS-000112-GPOS-00057
      - CCI-001941
      - CCI-001942
      - CAT2

- name: "MEDIUM | WN16-DC-000050 | AUDIT | The Kerberos policy user ticket renewal maximum lifetime must be limited to seven days or less."
  block:
      - name: "MEDIUM | WN16-DC-000050 | AUDIT | The Kerberos policy user ticket renewal maximum lifetime must be limited to seven days or less. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! The Kerberos policy user ticket renewal maximum lifetime must be limited to seven days or less."
                - "Configure the policy value in the Default Domain Policy for Computer Configuration"
                - ">> Policies >> Windows Settings >> Security Settings >> Account Policies >> Kerberos Policy"
                - ">> Maximum lifetime for user ticket renewal to a maximum of 7 days or less"

      - name: "MEDIUM | WN16-DC-000050 | AUDIT | The Kerberos policy user ticket renewal maximum lifetime must be limited to seven days or less. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-DC-000050'
  when:
      - wn16_dc_000050
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000050
      - V-224968
      - SV-224968r852343_rule
      - SRG-OS-000112-GPOS-00057
      - CCI-001941
      - CCI-001942
      - CAT2

- name: "MEDIUM | WN16-DC-000060 | AUDIT | The computer clock synchronization tolerance must be limited to 5 minutes or less."
  block:
      - name: "MEDIUM | WN16-DC-000060 | AUDIT | The computer clock synchronization tolerance must be limited to 5 minutes or less. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "This is a manual task. Windows Server 2016 computer clock synchronization tolerance"
                - "must be limited to five minutes or less."
                - "Configure the policy value in the Default Domain Policy for Computer Configuration"
                - ">> Policies >> Windows Settings >> Security Settings >> Account Policies >> Kerberos Policy"
                - ">> Maximum tolerance for computer clock synchronization to a maximum of 5 minutes or less."

      - name: "MEDIUM | WN16-DC-000060 | AUDIT | The computer clock synchronization tolerance must be limited to 5 minutes or less. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-DC-000060'
  when:
      - wn16_dc_000060
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000060
      - V-224969
      - SV-224969r852344_rule
      - SRG-OS-000112-GPOS-00057
      - CCI-001941
      - CCI-001942
      - CAT2

- name: "MEDIUM | WN16-DC-000120 | Data files owned by users must be on a different logical partition from the directory server data files."
  block:
      - name: "MEDIUM | WN16-DC-000120 | AUDIT | Data files owned by users must be on a different logical partition from the directory server data files. | Audit Current Dir Locations For DSA"
        ansible.windows.win_shell: Get-ItemProperty Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters -Name "Database log files path","DSA Database file"
        changed_when: false
        failed_when: false
        register: wn16_dc_000120_audit_dirlocation

      - name: "MEDIUM | WN16-DC-000120 | AUDIT | Data files owned by users must be on a different logical partition from the directory server data files. | Get Shared Drives"
        ansible.windows.win_shell: net share
        changed_when: false
        failed_when: false
        register: wn16_dc_000120_audit_shares

      - name: "MEDIUM | WN16-DC-000120 | AUDIT | Data files owned by users must be on a different logical partition from the directory server data files. | Warning Message."
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Data files owned by users must be on a different logical partition"
                - "from the directory server data files. Ignore system shares (e.g., NETLOGON, SYSVOL, and administrative"
                - "shares ending in $). User shares that are hidden (ending with $) should not be ignored."
                - "If user shares are located on the same logical partition as the directory server data files, this is a finding."
                - "Note the directory locations in the values for DSA Database file"
                - "{{ wn16_dc_000120_audit_dirlocation.stdout_lines | trim }}"
                - "Note the logical drive(s) or file system partition for any organization-created data shares."
                - "{{ wn16_dc_000120_audit_shares.stdout_lines | trim }}"

      - name: "MEDIUM | WN16-DC-000120 | AUDIT | Data files owned by users must be on a different logical partition from the directory server data files. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-DC-000120'
  when:
      - wn16_dc_000120
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000120
      - V-224975
      - SV-224975r569186_rule
      - SRG-OS-000138-GPOS-00069
      - CCI-001090
      - CAT2

- name: "MEDIUM | WN16-DC-000130 | AUDIT | Domain controllers must run on a machine dedicated to that function."
  block:
      - name: "MEDIUM | WN16-DC-000130 | AUDIT | Domain controllers must run on a machine dedicated to that function. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Domain controllers must run on a machine dedicated to that function."
                - "Review installed applications. Remove additional roles or applications such as web, database,"
                - "and email from the domain controller."

      - name: "MEDIUM | WN16-DC-000130 | PATCH | Domain controllers must run on a machine dedicated to that function. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-DC-000130'
  when:
      - wn16_dc_000130
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000130
      - V-224976
      - SV-224976r569186_rule
      - SRG-OS-000095-GPOS-00049
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN16-DC-000140 | AUDIT | Separate, NSA-approved (Type 1) cryptography must be used to protect the directory data in transit for directory service implementations at a classified confidentiality level when replication data traverses a network cleared to a lower level than the data."
  block:
      - name: "MEDIUM | WN16-DC-000140 | AUDIT | Separate, NSA-approved (Type 1) cryptography must be used to protect the directory data in transit for directory service implementations at a classified confidentiality level when replication data traverses a network cleared to a lower level than the data. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. If the classification level of the Windows domain controller is higher than"
                - "the level of the network traversed and NSA-approved encryption is not used, this is a finding."
                - "Configure NSA-approved (Type 1) cryptography to protect the directory data in transit for directory service"
                - "implementations at a classified confidentiality level that transfer replication data through a network cleared"
                - "to a lower level than the data."

      - name: "MEDIUM | WN16-DC-000140 | AUDIT | Separate, NSA-approved (Type 1) cryptography must be used to protect the directory data in transit for directory service implementations at a classified confidentiality level when replication data traverses a network cleared to a lower level than the data. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-DC-000140'
  when:
      - wn16_dc_000140
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000140
      - V-224977
      - SV-224977r878117_rule
      - SRG-OS-000396-GPOS-00176
      - CCI-002450
      - CAT2

- name: "MEDIUM | WN16-DC-000170 | AUDIT | Active Directory Group Policy objects must be configured with proper audit settings."
  block:
      - name: "MEDIUM | WN16-DC-000170 | AUDIT | Active Directory Group Policy objects must be configured with proper audit settings. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Active Directory Group Policy objects must be configured with proper audit settings."
                - "Please review the STIG documentation for proper direction on auditing this control."

      - name: "MEDIUM | WN16-DC-000170 | AUDIT | Active Directory Group Policy objects must be configured with proper audit settings. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-DC-000170'
  when:
      - wn16_dc_000170
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000170
      - V-224980
      - SV-224980r852352_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN16-DC-000180 | AUDIT | The Active Directory Domain object must be configured with proper audit settings."
  block:
      - name: "MEDIUM | WN16-DC-000180 | AUDIT | The Active Directory Domain object must be configured with proper audit settings. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. The Active Directory Domain object must be configured with proper audit settings."
                - "Please review the STIG documentation for proper direction on auditing this control."

      - name: "MEDIUM | WN16-DC-000180 | AUDIT | The Active Directory Domain object must be configured with proper audit settings. | Warning Cout"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-DC-000180'
  when:
      - wn16_dc_000180
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000180
      - V-224981
      - SV-224981r852353_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN16-DC-000190 | AUDIT | The Active Directory Infrastructure object must be configured with proper audit settings."
  block:
      - name: "MEDIUM | WN16-DC-000190 | AUDIT | The Active Directory Infrastructure object must be configured with proper audit settings. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. The Active Directory Infrastructure object must be configured with proper audit settings."
                - "Please review the STIG documentation for proper direction on auditing this control."

      - name: "MEDIUM | WN16-DC-000190 | AUDIT | The Active Directory Infrastructure object must be configured with proper audit settings. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-DC-000190'
  when:
      - wn16_dc_000190
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000190
      - V-224982
      - SV-224982r852354_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN16-DC-000200 | AUDIT |The Active Directory Domain Controllers Organizational Unit (OU) object must be configured with proper audit settings."
  block:
      - name: "MEDIUM | WN16-DC-000200 | AUDIT | The Active Directory Domain Controllers Organizational Unit (OU) object must be configured with proper audit settings. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. The Active Directory Domain Controllers Organizational"
                - "Unit (OU) object must be configured with proper audit settings."
                - "Please review the STIG documentation for proper direction on auditing this control."

      - name: "MEDIUM | WN16-DC-000200 | AUDIT | The Active Directory Domain Controllers Organizational Unit (OU) object must be configured with proper audit settings. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-DC-000200'
  when:
      - wn16_dc_000200
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000200
      - V-224983
      - SV-224983r852355_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN16-DC-000210 | AUDIT |The Active Directory AdminSDHolder object must be configured with proper audit settings."
  block:
      - name: "MEDIUM | WN16-DC-000210 | AUDIT | The Active Directory AdminSDHolder object must be configured with proper audit settings. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. The Active Directory AdminSDHolder object must be configured with proper audit settings."
                - "Please review the STIG documentation for proper direction on auditing this control."

      - name: "MEDIUM | WN16-DC-000210 | AUDIT | The Active Directory AdminSDHolder object must be configured with proper audit settings. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-DC-000210'
  when:
      - wn16_dc_000210
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000210
      - V-224984
      - SV-224984r852356_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN16-DC-000220 | AUDIT | The Active Directory RID Manager$ object must be configured with proper audit settings."
  block:
      - name: "MEDIUM | WN16-DC-000220 | AUDIT | The Active Directory RID Manager$ object must be configured with proper audit settings. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. The Active Directory RID Manager$ object must be configured with proper audit settings."
                - "Please review the STIG documentation for proper direction on auditing this control."

      - name: "MEDIUM | WN16-DC-000220 | AUDIT | The Active Directory RID Manager$ object must be configured with proper audit settings. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-DC-000220'
  when:
      - wn16_dc_000220
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000220
      - V-224985
      - SV-224985r852357_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002234
      - CAT2

- name: "MEDIUM | WN16-DC-000230 | PATCH | Windows Server 2016 must be configured to audit Account Management - Computer Account Management successes."
  block:
      - name: "MEDIUM | WN16-DC-000230 | AUDIT | Windows Server 2016 must be configured to audit Account Management - Computer Account Management successes. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Computer Account Management" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_dc_000230_audit

      - name: "MEDIUM | WN16-DC-000230 | PATCH | Windows Server 2016 must be configured to audit Account Management - Computer Account Management successes. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Computer Account Management" /success:enable
        when: "'Success' not in wn16_dc_000230_audit.stdout"
  when:
      - wn16_dc_000230
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000230
      - V-224986
      - SV-224986r852358_rule
      - SRG-OS-000004-GPOS-00004
      - CCI-000018
      - CCI-000172
      - CCI-001403
      - CCI-001404
      - CCI-001405
      - CCI-002130
      - CAT2

- name: "MEDIUM | WN16-DC-000240 | PATCH | Windows Server 2016 must be configured to audit DS Access - Directory Service Access successes."
  block:
      - name: "MEDIUM | WN16-DC-000240 | AUDIT | Windows Server 2016 must be configured to audit DS Access - Directory Service Access successes. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Directory Service Access" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_dc_000240_audit

      - name: "MEDIUM | WN16-DC-000240 | PATCH | Windows Server 2016 must be configured to audit DS Access - Directory Service Access successes. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Directory Service Access" /success:enable
        when: "'Success' not in wn16_dc_000240_audit.stdout"
  when:
      - wn16_dc_000240
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000240
      - V-224987
      - SV-224987r852359_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002334
      - CAT2

- name: "MEDIUM | WN16-DC-000250 | PATCH | Windows Server 2016 must be configured to audit DS Access - Directory Service Access failures."
  block:
      - name: "MEDIUM | WN16-DC-000250 | AUDIT | Windows Server 2016 must be configured to audit DS Access - Directory Service Access failures. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Directory Service Access" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_dc_000250_audit

      - name: "MEDIUM | WN16-DC-000250 | PATCH | Windows Server 2016 must be configured to audit DS Access - Directory Service Access failures. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Directory Service Access" /failure:enable
        when: "'Failure' not in wn16_dc_000250_audit.stdout"
  when:
      - wn16_dc_000250
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000250
      - V-224988
      - SV-224988r852360_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002334
      - CAT2

- name: "MEDIUM | WN16-DC-000260 | PATCH | Windows Server 2016 must be configured to audit DS Access - Directory Service Changes successes."
  block:
      - name: "MEDIUM | WN16-DC-000260 | AUDIT | Windows Server 2016 must be configured to audit DS Access - Directory Service Changes successes. | Get Current Setting"
        ansible.windows.win_shell: AuditPol /get /subcategory:"Directory Service Changes" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
        changed_when: false
        failed_when: false
        register: wn16_dc_000260_audit

      - name: "MEDIUM | WN16-DC-000260 | PATCH | Windows Server 2016 must be configured to audit DS Access - Directory Service Changes successes. | Set"
        ansible.windows.win_shell: AuditPol /set /subcategory:"Directory Service Changes" /success:enable
        when: "'Success' not in wn16_dc_000260_audit.stdout"
  when:
      - wn16_dc_000260
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000260
      - V-224989
      - SV-224989r852361_rule
      - SRG-OS-000327-GPOS-00127
      - CCI-000172
      - CCI-002334
      - CAT2

- name: "MEDIUM | WN16-DC-000280 | AUDIT | Domain controllers must have a PKI server certificate."
  block:
      - name: "MEDIUM | WN16-DC-000280 | AUDIT | Domain controllers must have a PKI server certificate. | Warning Message"
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Domain controllers must have a PKI server certificate."
                - "Please review the STIG documentation for proper direction on auditing this control."

      - name: "MEDIUM | WN16-DC-000280 | AUDIT | Domain controllers must have a PKI server certificate. | Warn Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-DC-000220'
  when:
      - wn16_dc_000280
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000280
      - V-224991
      - SV-224991r569186_rule
      - SRG-OS-000066-GPOS-00034
      - CCI-000185
      - CAT2

- name: "MEDIUM | WN16-DC-000310 | AUDIT | Active Directory user accounts, including administrators, must be configured to require the use of a Common Access Card (CAC), Personal Identity Verification (PIV)-compliant hardware token, or Alternate Logon Token (ALT) for user authentication."
  block:
      - name: "MEDIUM | WN16-DC-000310 | AUDIT | Active Directory user accounts, including administrators, must be configured to require the use of a Common Access Card (CAC), Personal Identity Verification (PIV)-compliant hardware token, or Alternate Logon Token (ALT) for user authentication. | Obtain Accounts"
        ansible.windows.win_shell: Get-ADUser -Filter {(Enabled -eq $True) -and (SmartcardLogonRequired -eq $False)} | FT Name
        changed_when: false
        failed_when: false
        register: wn16_dc_000310_audit

      - name: "MEDIUM | WN16-DC-000310 | AUDIT | Active Directory user accounts, including administrators, must be configured to require the use of a Common Access Card (CAC), Personal Identity Verification (PIV)-compliant hardware token, or Alternate Logon Token (ALT) for user authentication. | Warning Message."
        ansible.builtin.debug:
            msg:
                - "Warning!! This is a manual task. Active Directory user accounts, including administrators,"
                - "must be configured to require the use of a Common Access Card (CAC), Personal Identity Verification"
                - "(PIV)-compliant hardware token, or Alternate Logon Token (ALT) for user authentication."
                - "If any user accounts, including administrators, are listed below, this is a finding."
                - "Configure all user accounts, including administrator accounts, in Active Directory to enable"
                - "the option Smart card is required for interactive logon"
                - "{{ wn16_dc_000310_audit.stdout_lines | trim }}"

      - name: "MEDIUM | WN16-DC-000310 | AUDIT | Active Directory user accounts, including administrators, must be configured to require the use of a Common Access Card (CAC), Personal Identity Verification (PIV)-compliant hardware token, or Alternate Logon Token (ALT) for user authentication. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-DC-000310'
  when:
      - wn16_dc_000310
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000310
      - V-224994
      - SV-224994r852363_rule
      - SRG-OS-000105-GPOS-00052
      - CCI-000765
      - CCI-000766
      - CCI-000767
      - CCI-000768
      - CCI-001948
      - CAT2

- name: "MEDIUM | WN16-DC-000320 | PATCH | Domain controllers must require LDAP access signing."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\NTDS\Parameters
      state: present
      value: LDAPServerIntegrity
      data: 2
      datatype: dword
  when:
      - wn16_dc_000320
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000320
      - V-224995
      - SV-224995r852364_rule
      - SRG-OS-000423-GPOS-00187
      - SV-88293r1_rule
      - CCI-002418
      - CCI-002421
      - CAT2

- name: "MEDIUM | WN16-DC-000330 | PATCH | Domain controllers must be configured to allow reset of machine account passwords."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
      state: present
      value: RefusePasswordChange
      data: 0
      datatype: dword
  when:
      - wn16_dc_000330
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000330
      - V-224996
      - SV-224996r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-DC-000340 | PATCH | The Access this computer from the network user right must only be assigned to the Administrators, Authenticated Users, and Enterprise Domain Controllers groups on domain controllers."
  ansible.windows.win_user_right:
      name: SeNetworkLogonRight
      users:
          - Administrators
          - Authenticated Users
          - Enterprise Domain Controllers
      action: set
  when:
      - wn16_dc_000340
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000340
      - V-224997
      - SV-224997r569186_rule
      - SRG-OS-000080-GPOS-00048
      - CCI-000213
      - CAT2

- name: "MEDIUM | WN16-DC-000350 | PATCH | The Add workstations to domain user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeMachineAccountPrivilege
      users: Administrators
      action: set
  when:
      - wn16_dc_000350
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000350
      - V-224998
      - SV-224998r877392_rule
      - SRG-OS-000324-GPOS-00125
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN16-DC-000360 | PATCH | The Allow log on through Remote Desktop Services user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeRemoteInteractiveLogonRight
      users: Administrators
      action: set
  when:
      - wn16_dc_000360
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000360
      - V-224999
      - SV-224999r569186_rule
      - SRG-OS-000080-GPOS-00048
      - CCI-000213
      - CAT2

- name: "MEDIUM | WN16-DC-000370 | PATCH | The Deny access to this computer from the network user right on domain controllers must be configured to prevent unauthenticated access."
  ansible.windows.win_user_right:
      name: SeDenyNetworkLogonRight
      users: Guests
      action: set
  when:
      - wn16_dc_000370
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000370
      - V-225000
      - SV-225000r569186_rule
      - SRG-OS-000080-GPOS-00048
      - CCI-000213
      - CAT2

- name: "MEDIUM | WN16-DC-000380 | PATCH | The Deny log on as a batch job user right on domain controllers must be configured to prevent unauthenticated access."
  ansible.windows.win_user_right:
      name: SeDenyBatchLogonRight
      users: Guests
      action: set
  when:
      - wn16_dc_000380
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000380
      - V-225001
      - SV-225001r569186_rule
      - SRG-OS-000080-GPOS-00048
      - CCI-000213
      - CAT2

- name: "MEDIUM | WN16-DC-000390 | PATCH | The Deny log on as a service user right must be configured to include no accounts or groups (blank) on domain controllers."
  community.windows.win_security_policy:
      section: Privilege Rights
      key: SeDenyServiceLogonRight
      value: ""
  when:
      - wn16_dc_000390
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000390
      - V-225002
      - SV-225002r569186_rule
      - SRG-OS-000080-GPOS-00048
      - CCI-000213
      - CAT2

- name: "MEDIUM | WN16-DC-000400 | PATCH | The Deny log on locally user right on domain controllers must be configured to prevent unauthenticated access."
  ansible.windows.win_user_right:
      name: SeDenyInteractiveLogonRight
      users: Guests
      action: set
  when:
      - wn16_dc_000400
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000400
      - V-225003
      - SV-225003r569186_rule
      - SRG-OS-000080-GPOS-00048
      - CCI-000213
      - CAT2

- name: "MEDIUM | WN16-DC-000410 | PATCH | The Deny log on through Remote Desktop Services user right on domain controllers must be configured to prevent unauthenticated access."
  ansible.windows.win_user_right:
      name: SeDenyRemoteInteractiveLogonRight
      users: Guests
      action: set
  when:
      - wn16_dc_000410
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000410
      - V-225004
      - SV-225004r852366_rule
      - SRG-OS-000297-GPOS-00115
      - CCI-002314
      - CAT2

- name: "MEDIUM | WN16-DC-000420 | PATCH | The Enable computer and user accounts to be trusted for delegation user right must only be assigned to the Administrators group on domain controllers."
  ansible.windows.win_user_right:
      name: SeEnableDelegationPrivilege
      users: Administrators
      action: set
  when:
      - wn16_dc_000420
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-DC-000420
      - V-225005
      - SV-225005r877392_rule
      - SRG-OS-000324-GPOS-00125
      - CCI-002235
      - CAT2

## this seems highly prone to breakage? its a DC acct, has replicate. if you screw it up, it could stop kerberos tickets and break auth things
## https://www.kjctech.net/do-you-need-to-update-krbtgt-account-password/
- name: "MEDIUM | WN16-DC-000430 | AUDIT | The password for the krbtgt account on a domain must be reset at least every 180 days."
  block:
      - name: "MEDIUM | WN16-DC-000430 | AUDIT | The password for the krbtgt account on a domain must be reset at least every 180 days. | Warning Message Variable."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have a invalid number of days set for wn16stig_krbtgt_account_pass_age please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when: wn16stig_krbtgt_account_pass_age > 180

      - name: "MEDIUM | WN16-DC-000430 | AUDIT | The password for the krbtgt account on a domain must be reset at least every 180 days. | Get Password Last Set"
        ansible.windows.win_shell: "Get-ADUser krbtgt -Property PasswordLastSet | Where-Object {$_.PasswordLastSet -lt ((Get-Date).AddDays(-{{ wn16stig_krbtgt_account_pass_age }}))} | Select-Object -ExpandProperty PasswordLastSet"
        changed_when: false
        failed_when: false
        register: wn16_dc_000430_audit
        when: wn16stig_krbtgt_account_pass_age <= 180

      - name: "MEDIUM | WN16-DC-000430 | AUDIT | The password for the krbtgt account on a domain must be reset at least every 180 days. | Warning Message Account."
        ansible.builtin.debug:
            msg:
                - "Warning!! The password for the krbtgt account on a domain must be reset at least every 180 days."
                - "Your password is currently out of STIG compliance and has not been reset in the last 180 days."
                - "{{ wn16_dc_000430_audit.stdout_lines | trim }}"
        when:
            - wn16stig_krbtgt_account_pass_age <= 180
            - wn16_dc_000430_audit.stdout | length > 0

      - name: "MEDIUM | WN16-DC-000430 | AUDIT | The password for the krbtgt account on a domain must be reset at least every 180 days. | Warning Count"
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-DC-000310'
        when:
            - wn16stig_krbtgt_account_pass_age <= 180
            - wn16_dc_000430_audit.stdout | length > 0 or
              wn16stig_krbtgt_account_pass_age > 180
  when:
      - wn16_dc_000430
      - ansible_windows_domain_role == "Primary domain controller"
      - win2016stig_complexity_high
  tags:
      - WN16-DC-000430
      - V-225006
      - SV-225006r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-MS-000020 | PATCH | Local administrator accounts must have their privileged token filtered to prevent elevated privileges from being used over the network on domain systems."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      state: present
      value: LocalAccountTokenFilterPolicy
      data: 0
      datatype: dword
  when:
      - wn16_ms_000020
      - ansible_windows_domain_role == "Member server"
  tags:
      - WN16-MS-000020
      - V-225008
      - SV-225008r857258_rule
      - SRG-OS-000134-GPOS-00068
      - CCI-001084
      - CAT2

- name: "MEDIUM | WN16-MS-000030 | PATCH | Local users on domain-joined computers must not be enumerated."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\System
      state: present
      value: EnumerateLocalUsers
      data: 0
      datatype: dword
  when:
      - wn16_ms_000030
      - ansible_windows_domain_role == "Member server"
  tags:
      - WN16-MS-000030
      - V-225009
      - SV-225009r857260_rule
      - SRG-OS-000095-GPOS-00049
      - CCI-000381
      - CAT2

- name: "MEDIUM | WN16-MS-000040 | PATCH | Unauthenticated Remote Procedure Call (RPC) clients must be restricted from connecting to the RPC server."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Rpc
      state: present
      value: RestrictRemoteClients
      data: 1
      datatype: dword
  when:
      - wn16_ms_000040
      - not ansible_windows_domain_role == "Primary domain controller"
  tags:
      - WN16-MS-000040
      - V-225010
      - SV-225010r877039_rule
      - SRG-OS-000379-GPOS-00164
      - CCI-001967
      - CAT2

- name: "MEDIUM | WN16-MS-000050 | PATCH | Caching of logon credentials must be limited."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon
      state: present
      value: CachedLogonsCount
      data: 4
      datatype: dword
  when:
      - wn16_ms_000050
      - ansible_windows_domain_role == "Member server"
  tags:
      - WN16-MS-000050
      - V-225011
      - SV-225011r857264_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-MS-000310 | PATCH | Remote calls to the Security Account Manager (SAM) must be restricted to Administrators."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
      state: present
      value: RestrictRemoteSAM
      data: O:BAG:BAD:(A;;RC;;;BA)
      datatype: string
  when:
      - wn16_ms_000310
  tags:
      - WN16-MS-000310
      - V-225013
      - SV-225013r877392_rule
      - SRG-OS-000324-GPOS-00125
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN16-MS-000340 | PATCH | The Access this computer from the network user right must only be assigned to the Administrators and Authenticated Users groups on member servers."
  ansible.windows.win_user_right:
      name: SeNetworkLogonRight
      users:
          - Administrators
          - Authenticated Users
      action: set
  when:
      - wn16_ms_000340
  tags:
      - WN16-MS-000340
      - V-225014
      - SV-225014r857272_rule
      - SRG-OS-000080-GPOS-00048
      - CCI-000213
      - CAT2

- name: "MEDIUM | WN16-MS-000370 | PATCH | The Deny access to this computer from the network user right on member servers must be configured to prevent access from highly privileged domain accounts and local accounts on domain systems, and from unauthenticated access on all systems."
  block:
      - name: "MEDIUM | WN16-MS-000370 | DOMAIN MEMBER - PATCH | The Deny access to this computer from the network user right on member servers must be configured to prevent access from highly privileged domain accounts and local accounts on domain systems, and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyNetworkLogonRight
            users:
                - Guests
                - Enterprise Admins
                - Domain Admins
                - Local account
                - Local account and member of Administrators group
            action: set
        when: ansible_windows_domain_role == "Member server"

      - name: "MEDIUM | WN16-MS-000370 | STAND-ALONE - PATCH | The Deny access to this computer from the network user right on member servers must be configured to prevent access from highly privileged domain accounts and local accounts on domain systems, and from unauthenticated access on all systems"
        ansible.windows.win_user_right:
            name: SeDenyNetworkLogonRight
            users: Guests
            action: set
        when: not ansible_windows_domain_member
  when:
      - wn16_ms_000370
  tags:
      - WN16-MS-000370
      - V-225015
      - SV-225015r857274_rule
      - SRG-OS-000080-GPOS-00048
      - CCI-000213
      - CAT2

- name: "MEDIUM | WN16-MS-000380 | PATCH | The Deny log on as a batch job user right on member servers must be configured to prevent access from highly privileged domain accounts on domain systems and from unauthenticated access on all systems."
  block:
      - name: "MEDIUM | WN16-MS-000380 | DOMAIN MEMBER - PATCH | The Deny log on as a batch job user right on member servers must be configured to prevent access from highly privileged domain accounts on domain systems and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyBatchLogonRight
            users:
                - Enterprise Admins
                - Domain Admins
                - Guests
            action: set
        when: ansible_windows_domain_role == "Member server"

      - name: "MEDIUM | WN16-MS-000380 | STAND-ALONE - PATCH | The Deny log on as a batch job user right on member servers must be configured to prevent access from highly privileged domain accounts on domain systems and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyBatchLogonRight
            users:
                - Guests
            action: set
        when: not ansible_windows_domain_member
  when:
      - wn16_ms_000380
  tags:
      - WN16-MS-000380
      - V-225016
      - SV-225016r857276_rule
      - SRG-OS-000080-GPOS-00048
      - CCI-000213
      - CAT2

- name: "MEDIUM | WN16-MS-000390 | PATCH | The Deny log on as a service user right on member servers must be configured to prevent access from highly privileged domain accounts on domain systems. No other groups or accounts must be assigned this right."
  ansible.windows.win_user_right:
      name: SeDenyServiceLogonRight
      users:
          - Enterprise Admins
          - Domain Admins
      action: set
  when:
      - wn16_ms_000390
      - ansible_windows_domain_role == "Member server"
  tags:
      - WN16-MS-000390
      - V-225017
      - SV-225017r890505_rule
      - SRG-OS-000080-GPOS-00048
      - CCI-000213
      - CAT2

- name: "MEDIUM | WN16-MS-000400 | PATCH | The Deny log on locally user right on member servers must be configured to prevent access from highly privileged domain accounts on domain systems and from unauthenticated access on all systems."
  block:
      - name: "MEDIUM | WN16-MS-000400 | DOMAIN MEMBER - PATCH | The Deny log on locally user right on member servers must be configured to prevent access from highly privileged domain accounts on domain systems and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyInteractiveLogonRight
            users:
                - Guests
                - Enterprise Admins
                - Domain Admins
            action: set
        when: ansible_windows_domain_role == "Member server"

      - name: "MEDIUM | WN16-MS-000400 | STAND-ALONE - PATCH | The Deny log on locally user right on member servers must be configured to prevent access from highly privileged domain accounts on domain systems and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyInteractiveLogonRight
            users:
                - Guests
            action: set
        when: not ansible_windows_domain_member
  when:
      - wn16_ms_000400
  tags:
      - WN16-MS-000400
      - V-225018
      - SSV-225018r857278_rule
      - SRG-OS-000080-GPOS-00048
      - CCI-000213
      - CAT2

- name: "MEDIUM | WN16-MS-000410 | PATCH | The Deny log on through Remote Desktop Services user right on member servers must be configured to prevent access from highly privileged domain accounts and all local accounts on domain systems and from unauthenticated access on all systems."
  block:
      - name: "MEDIUM | WN16-MS-000410 | DOMAIN MEMBER - PATCH | The Deny log on through Remote Desktop Services user right on member servers must be configured to prevent access from highly privileged domain accounts and all local accounts on domain systems and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyRemoteInteractiveLogonRight
            users:
                - Guests
                - Local account
                - Enterprise Admins
                - Domain Admins
            action: set
        when: ansible_windows_domain_role == "Member server"

      - name: "MEDIUM | WN16-MS-000410 | STAND-ALONE - PATCH | The Deny log on through Remote Desktop Services user right on member servers must be configured to prevent access from highly privileged domain accounts and all local accounts on domain systems and from unauthenticated access on all systems."
        ansible.windows.win_user_right:
            name: SeDenyRemoteInteractiveLogonRight
            users:
                - Guests
            action: set
        when: not ansible_windows_domain_member
  when:
      - wn16_ms_000410
  tags:
      - WN16-MS-000410
      - V-225019
      - SV-225019r860023_rule
      - SRG-OS-000297-GPOS-00115
      - CCI-002314
      - CAT2

- name: "MEDIUM | WN16-MS-000420 | PATCH | The Enable computer and user accounts to be trusted for delegation user right must not be assigned to any groups or accounts on member servers."
  community.windows.win_security_policy:
      section: Privilege Rights
      key: SeEnableDelegationPrivilege
      value: ""
  when:
      - wn16_ms_000420
  tags:
      - WN16-MS-000420
      - V-225020
      - SV-225020r877392_rule
      - SRG-OS-000324-GPOS-00125
      - CCI-002235
      - CAT2

# https://dl.dod.cyber.mil/wp-content/uploads/pki-pke/zip/certificates_pkcs7_v5-6_dod.zip ?
- name: "MEDIUM | WN16-PK-000010 | AUDIT | The DoD Root CA certificates must be installed in the Trusted Root Store."
  block:
      - name: "MEDIUM | WN16-PK-000010 | AUDIT | The DoD Root CA certificates must be installed in the Trusted Root Store. | Check For DOD Root CA 3."
        ansible.windows.win_shell: Get-ChildItem -Path Cert:Localmachine\root | Where {$_.Subject -Like "*DoD Root CA 3*" -and $_.Thumbprint -Like "D73CA91102A2204A36459ED32213B467D7CE97FB"} | FL Subject, Issuer, Thumbprint, NotAfter
        changed_when: false
        failed_when: false
        register: wn16_pk_000010_root_3_Check

      - name: "MEDIUM | WN16-PK-000010 | AUDIT | The DoD Root CA certificates must be installed in the Trusted Root Store. | Check For DOD Root CA 4."
        ansible.windows.win_shell: Get-ChildItem -Path Cert:Localmachine\root | Where {$_.Subject -Like "*DoD Root CA 4*" -and $_.Thumbprint -Like "B8269F25DBD937ECAFD4C35A9838571723F2D026"} | FL Subject, Issuer, Thumbprint, NotAfter
        changed_when: false
        failed_when: false
        register: wn16_pk_000010_root_4_Check

      - name: "MEDIUM | WN16-PK-000010 | AUDIT | The DoD Root CA certificates must be installed in the Trusted Root Store. | Check For DOD Root CA 5."
        ansible.windows.win_shell: Get-ChildItem -Path Cert:Localmachine\root | Where {$_.Subject -Like "*DoD Root CA 5*" -and $_.Thumbprint -Like "4ECB5CC3095670454DA1CBD410FC921F46B8564B"} | FL Subject, Issuer, Thumbprint, NotAfter
        changed_when: false
        failed_when: false
        register: wn16_pk_000010_root_5_Check

      - name: "MEDIUM | WN16-PK-000010 | AUDIT | The DoD Root CA certificates must be installed in the Trusted Root Store. | Warning!! No DOD Root CA 3 Certificate Installed."
        ansible.builtin.debug:
            msg:
                - "Warning!! The DOD Root CA 3 is not installed on the system or"
                - "contains a incorrect Thumbprint for the Root CA Certificate."
                - "Please refer to STIG documentation for proper cert to be installed."
        when: wn16_pk_000010_root_3_Check.stdout == ""

      - name: "MEDIUM | WN16-PK-000010 | AUDIT | The DoD Root CA certificates must be installed in the Trusted Root Store. | Warning!! No DOD Root CA 4 Certificate Installed."
        ansible.builtin.debug:
            msg:
                - "Warning!! The DOD Root CA 4 is not installed on the system or"
                - "contains a incorrect Thumbprint for the Root CA Certificate."
                - "Please refer to STIG documentation for proper cert to be installed."
        when: wn16_pk_000010_root_4_Check.stdout == ""

      - name: "MEDIUM | WN16-PK-000010 | AUDIT | The DoD Root CA certificates must be installed in the Trusted Root Store. | Warning!! No DOD Root CA 5 Certificate Installed."
        ansible.builtin.debug:
            msg:
                - "Warning!! The DOD Root CA 5 is not installed on the system or"
                - "contains a incorrect Thumbprint for the Root CA Certificate."
                - "Please refer to STIG documentation for proper cert to be installed."
        when: wn16_pk_000010_root_5_Check.stdout == ""

      - name: "MEDIUM | WN16-PK-000010 | AUDIT | The DoD Root CA certificates must be installed in the Trusted Root Store. | Warning Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-PK-000010'
        when:
            - wn16_pk_000010_root_3_Check.stdout == "" or
              wn16_pk_000010_root_4_Check.stdout == "" or
              wn16_pk_000010_root_5_Check.stdout == ""
  when:
      - wn16_pk_000010
  tags:
      - WN16-PK-000010
      - V-225021
      - SV-225021r890508_rule
      - SRG-OS-000066-GPOS-00034
      - CCI-000185
      - CCI-002470
      - CAT2

- name: "MEDIUM | WN16-PK-000020 | AUDIT | The DoD Interoperability Root CA cross-certificates must be installed in the Untrusted Certificates Store on unclassified systems."
  block:
      - name: "MEDIUM | WN16-PK-000020 | AUDIT | The DoD Interoperability Root CA cross-certificates must be installed in the Untrusted Certificates Store on unclassified systems. | DoD Interoperability Root CA 2 49 Thumb Check."
        ansible.windows.win_shell: Get-ChildItem -Path Cert:Localmachine\disallowed | Where {$_.Issuer -Like "*DoD Interoperability*" -and $_.Subject -Like "*DoD*" -and $_.Thumbprint -Like "49CBE933151872E17C8EAE7F0ABA97FB610F6477"} | FL Subject, Issuer, Thumbprint, NotAfter
        changed_when: false
        failed_when: false
        register: wn16_pk_000020_interop_check_for_49

      - name: "MEDIUM | WN16-PK-000020 | AUDIT | The DoD Interoperability Root CA cross-certificates must be installed in the Untrusted Certificates Store on unclassified systems. | Warning!! No DoD Interoperability Root CA 2 Certificate Installed."
        ansible.builtin.debug:
            msg:
                - "Warning!! The DoD Root CA 3 - DoD Interoperability Root CA 2 certificate is not installed on the system or"
                - "does not contain Thumbprint 49CBE933151872E17C8EAE7F0ABA97FB610F6477 for the Certificate."
        when: wn16_pk_000020_interop_check_for_49.stdout == ""

      - name: "MEDIUM | WN16-PK-000020 | AUDIT | The DoD Interoperability Root CA cross-certificates must be installed in the Untrusted Certificates Store on unclassified systems. | Warning Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-PK-000020'
        when: wn16_pk_000020_interop_check_for_49.stdout == ""
  when:
      - wn16_pk_000020
  tags:
      - WN16-PK-000020
      - V-225022
      - SV-225022r894338_rule
      - SRG-OS-000066-GPOS-00034
      - CCI-000185
      - CCI-002440
      - CAT2

- name: "MEDIUM | WN16-PK-000030 | AUDIT | The US DoD CCEB Interoperability Root CA cross-certificates must be installed in the Untrusted Certificates Store on unclassified systems."
  block:
      - name: "MEDIUM | WN16-PK-000030 | AUDIT | The US DoD CCEB Interoperability Root CA cross-certificates must be installed in the Untrusted Certificates Store on unclassified systems. | DoD CCEB Interop Check."
        ansible.windows.win_shell: Get-ChildItem -Path Cert:Localmachine\disallowed | Where {$_.Issuer -Like "*US DoD CCEB Interoperability Root CA 2*" -and $_.Subject -Like "*DoD Root CA 3*" -and $_.Thumbprint -Like "9B74964506C7ED9138070D08D5F8B969866560C8"} | FL Subject, Issuer, Thumbprint, NotAfter
        changed_when: false
        failed_when: false
        register: wn16_pk_000030_cceb_interop_check

      - name: "MEDIUM | WN16-PK-000030 | AUDIT | The US DoD CCEB Interoperability Root CA cross-certificates must be installed in the Untrusted Certificates Store on unclassified systems. | Warning!! No DoD Root CA 3 - US DoD CCEB Interoperability Certificate Installed."
        ansible.builtin.debug:
            msg:
                - "Warning!! The DoD Root CA 3 - US DoD CCEB Interoperability Root CA 2 certificate is not installed on the system or"
                - "does not contain Thumbprint 9B74964506C7ED9138070D08D5F8B969866560C8 for the Certificate."
        when: wn16_pk_000030_cceb_interop_check.stdout == ""

      - name: "MEDIUM | WN16-PK-000030 | AUDIT | The US DoD CCEB Interoperability Root CA cross-certificates must be installed in the Untrusted Certificates Store on unclassified systems. | Warning Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-PK-000030'
        when: wn16_pk_000030_cceb_interop_check.stdout == ""
  when:
      - wn16_pk_000030
  tags:
      - WN16-PK-000030
      - V-225023
      - SV-225023r890514_rule
      - SRG-OS-000066-GPOS-00034
      - CCI-000185
      - CCI-002470
      - CAT2

- name: "MEDIUM | WN16-SO-000010 | PATCH | Windows Server 2016 built-in guest account must be disabled."
  community.windows.win_security_policy:
      section: System Access
      key: EnableGuestAccount
      value: 0
  when:
      - wn16_so_000010
  tags:
      - WN16-SO-000010
      - V-225024
      - SV-225024r569186_rule
      - SRG-OS-000121-GPOS-00062
      - CCI-000804
      - CAT2

- name: "MEDIUM | WN16-SO-000030 | PATCH | Windows Server 2016 built-in administrator account must be renamed."
  block:
      - name: "MEDIUM | WN16-SO-000030 | AUDIT | Windows Server 2016 built-in administrator account must be renamed. | Change Admin Name Warning."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have not changed the default name for wn16stig_newadministratorname, please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when: "'adminchangethis' in wn16stig_newadministratorname"

      - name: "MEDIUM | WN16-SO-000030 | AUDIT | Windows Server 2016 built-in administrator account must be renamed. | Warning Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-SO-000030'
        when: "'adminchangethis' in wn16stig_newadministratorname"

      - name: "MEDIUM | WN16-SO-000030 | PATCH | Windows Server 2016 built-in administrator account must be renamed. | Change Admin Name"
        community.windows.win_security_policy:
            section: System Access
            key: NewAdministratorName
            value: "{{ wn16stig_newadministratorname }}"
        when: "'adminchangethis' not in wn16stig_newadministratorname"
  when:
      - wn16_so_000030
      - not win_skip_for_test
  tags:
      - WN16-SO-000030
      - V-225026
      - SV-225026r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-SO-000040 | PATCH | Windows Server 2016 built-in guest account must be renamed."
  block:
      - name: "MEDIUM | WN16-SO-000040 | AUDIT | Windows Server 2016 built-in guest account must be renamed. | Warning For Bad Variable."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have not changed the default name for wn16stig_newguestname, please read"
                - "the notes for the variable and make the necessary change to the variable to be in compliance."
        when: "'guestchangethis' in wn16stig_newguestname"

      - name: "MEDIUM | WN16-SO-000040 | AUDIT | Windows Server 2016 built-in guest account must be renamed. | Warning Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN19-SO-000040'
        when: "'guestchangethis' in wn16stig_newguestname"

      - name: "MEDIUM | WN16-SO-000040 | PATCH | Windows Server 2016 built-in guest account must be renamed. | Set Variable."
        community.windows.win_security_policy:
            section: System Access
            key: NewGuestName
            value: "{{ wn16stig_newguestname }}"
        when: "'guestchangethis' not in wn16stig_newguestname"
  when:
      - wn16_so_000040
  tags:
      - WN16-SO-000040
      - V-225027
      - SV-225027r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-SO-000050 | PATCH | Audit policy using subcategories must be enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\
      state: present
      value: SCENoApplyLegacyAuditPolicy
      data: 1
      datatype: dword
  when:
      - wn16_so_000050
  tags:
      - WN16-SO-000050
      - V-225028
      - SV-225028r569186_rule
      - SRG-OS-000062-GPOS-00031
      - CCI-000169
      - CAT2

- name: "MEDIUM | WN16-SO-000080 | PATCH | The setting Domain member: Digitally encrypt or sign secure channel data (always) must be configured to Enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
      state: present
      value: RequireSignOrSeal
      data: 1
      datatype: dword
  when:
      - wn16_so_000080
      - ansible_windows_domain_role == "Member server"
  tags:
      - WN16-SO-000080
      - V-225029
      - SV-225029r852378_rule
      - SRG-OS-000423-GPOS-00187
      - CCI-002418
      - CCI-002421
      - CAT2

- name: "MEDIUM | WN16-SO-000090 | PATCH | The setting Domain member: Digitally encrypt secure channel data (when possible) must be configured to enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
      state: present
      value: SealSecureChannel
      data: 1
      datatype: dword
  when:
      - wn16_so_000090
      - ansible_windows_domain_role == "Member server"
  tags:
      - WN16-SO-000090
      - V-225030
      - SV-225030r852379_rule
      - SRG-OS-000423-GPOS-00187
      - CCI-002418
      - CCI-002421
      - CAT2

- name: "MEDIUM | WN16-SO-000100 | PATCH | The setting Domain member: Digitally sign secure channel data (when possible) must be configured to Enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
      state: present
      value: SignSecureChannel
      data: 1
      datatype: dword
  when:
      - wn16_so_000100
      - ansible_windows_domain_role == "Member server"
  tags:
      - WN16-SO-000100
      - V-225031
      - SV-225031r852380_rule
      - SRG-OS-000423-GPOS-00187
      - CCI-002418
      - CCI-002421
      - CAT2

- name: "MEDIUM | WN16-SO-000110 | PATCH | The computer account password must not be prevented from being reset."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
      state: present
      value: DisablePasswordChange
      data: 0
      datatype: dword
  when:
      - wn16_so_000110
  tags:
      - WN16-SO-000110
      - V-225032
      - SV-225032r877039_rule
      - SRG-OS-000379-GPOS-00164
      - CCI-001967
      - CAT2

- name: "MEDIUM | WN16-SO-000120 | PATCH | The maximum age for machine account passwords must be configured to 30 days or less."
  block:
      - name: "MEDIUM | WN16-SO-000120 | AUDIT | The maximum age for machine account passwords must be configured to 30 days or less. | Number Of Days Check."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have have not set the right number of days for wn16stig_machineaccountpsswd_max_age"
                - "Please read the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - wn16stig_machineaccountpsswd_max_age > 30 or
              wn16stig_machineaccountpsswd_max_age == 0

      - name: "MEDIUM | WN16-SO-000120 | AUDIT | The maximum age for machine account passwords must be configured to 30 days or less. | Warning Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-SO-000120'
        when:
            - wn16stig_machineaccountpsswd_max_age > 30 or
              wn16stig_machineaccountpsswd_max_age == 0

      - name: "MEDIUM | WN16-SO-000120 | PATCH | The maximum age for machine account passwords must be configured to 30 days or less. | Apply Variable."
        ansible.windows.win_regedit:
            path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
            state: present
            value: MaximumPasswordAge
            data: "{{ wn16stig_machineaccountpsswd_max_age }}"
            datatype: dword
        when:
            - wn16stig_machineaccountpsswd_max_age <= 30
            - wn16stig_machineaccountpsswd_max_age != 0
  when:
      - wn16_so_000120
  tags:
      - WN16-SO-000120
      - V-225033
      - SV-225033r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-SO-000130 | PATCH | Windows Server 2016 must be configured to require a strong session key."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
      state: present
      value: RequireStrongKey
      data: 1
      datatype: dword
  when:
      - wn16_so_000130
  tags:
      - WN16-SO-000130
      - V-225034
      - SV-225034r852382_rule
      - SRG-OS-000423-GPOS-00187
      - CCI-002418
      - CCI-002421
      - CAT2

- name: "MEDIUM | WN16-SO-000140 | PATCH | The machine inactivity limit must be set to 15 minutes, locking the system with the screen saver."
  block:
      - name: "MEDIUM | WN16-SO-000140 | AUDIT | The machine inactivity limit must be set to 15 minutes, locking the system with the screen saver. | Number Of Seconds Check."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have have not set the right number of seconds for wn16stig_inactivitytimeoutsecs"
                - "Please read the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - wn16stig_inactivitytimeoutsecs > 900 or
              wn16stig_inactivitytimeoutsecs == 0

      - name: "MEDIUM | WN16-SO-000140 | AUDIT | The machine inactivity limit must be set to 15 minutes, locking the system with the screen saver. | Warning Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-SO-000140'
        when:
            - wn16stig_inactivitytimeoutsecs > 900 or
              wn16stig_inactivitytimeoutsecs == 0

      - name: "MEDIUM | WN16-SO-000140 | PATCH | The machine inactivity limit must be set to 15 minutes, locking the system with the screen saver. | Apply Variable."
        ansible.windows.win_regedit:
            path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
            state: present
            value: InactivityTimeoutSecs
            data: "{{ wn16stig_inactivitytimeoutsecs }}"
            datatype: dword
        when:
            - wn16stig_inactivitytimeoutsecs <= 900
            - wn16stig_inactivitytimeoutsecs != 0
  when:
      - wn16_so_000140
  tags:
      - WN16-SO-000140
      - V-225035
      - SV-225035r569186_rule
      - SRG-OS-000029-GPOS-00010
      - CCI-000057
      - CAT2

- name: "MEDIUM | WN16-SO-000150 | PATCH | The required legal notice must be configured to display before console logon."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      state: present
      value: LegalNoticeText
      data: "{{ wn16stig_legalnoticetext }}"
      datatype: string
  when:
      - wn16_so_000150
  tags:
      - WN16-SO-000150
      - V-225036
      - SV-225036r569186_rule
      - SRG-OS-000023-GPOS-00006
      - CCI-000048
      - CCI-000050
      - CCI-001384
      - CCI-001385
      - CCI-001386
      - CCI-001387
      - CCI-001388
      - CAT2

- name: "MEDIUM | WN16-SO-000180 | PATCH | The Smart Card removal option must be configured to Force Logoff or Lock Workstation."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon
      state: present
      value: scremoveoption
      data: 1
      datatype: string
  when:
      - wn16_so_000180
  tags:
      - WN16-SO-000180
      - V-225038
      - SV-225038r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-SO-000190 | PATCH | The setting Microsoft network client: Digitally sign communications (always) must be configured to Enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters
      state: present
      value: RequireSecuritySignature
      data: 1
      datatype: dword
  when:
      - wn16_so_000190
  tags:
      - WN16-SO-000190
      - V-225039
      - SV-225039r852383_rule
      - SRG-OS-000423-GPOS-00187
      - CCI-002418
      - CCI-002421
      - CAT2

- name: "MEDIUM | WN16-SO-000200 | PATCH | The setting Microsoft network client: Digitally sign communications (if server agrees) must be configured to Enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters
      state: present
      value: EnableSecuritySignature
      data: 1
      datatype: dword
  when:
      - wn16_so_000200
  tags:
      - WN16-SO-000200
      - V-225040
      - SV-225040r852384_rule
      - SRG-OS-000423-GPOS-00187
      - CCI-002418
      - CCI-002421
      - CAT2

- name: "MEDIUM | WN16-SO-000210 | PATCH | Unencrypted passwords must not be sent to third-party Server Message Block (SMB) servers."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters
      state: present
      value: EnablePlainTextPassword
      data: 0
      datatype: dword
  when:
      - wn16_so_000210
  tags:
      - WN16-SO-000210
      - V-225041
      - SV-225041r877396_rule
      - SRG-OS-000074-GPOS-00042
      - CCI-002421
      - CAT2

- name: "MEDIUM | WN16-SO-000230 | PATCH | The setting Microsoft network server: Digitally sign communications (always) must be configured to Enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\LanManServer\Parameters
      state: present
      value: RequireSecuritySignature
      data: 1
      datatype: dword
  when:
      - wn16_so_000230
  tags:
      - WN16-SO-000230
      - V-225042
      - SV-225042r852385_rule
      - SRG-OS-000423-GPOS-00187
      - CCI-002418
      - CCI-002421
      - CAT2

- name: "MEDIUM | WN16-SO-000240 | PATCH | The setting Microsoft network server: Digitally sign communications (if client agrees) must be configured to Enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\LanManServer\Parameters
      state: present
      value: EnableSecuritySignature
      data: 1
      datatype: dword
  when:
      - wn16_so_000240
  tags:
      - WN16-SO-000240
      - V-225043
      - SV-225043r852386_rule
      - SRG-OS-000423-GPOS-00187
      - CCI-002418
      - CCI-002421
      - CAT2

- name: "MEDIUM | WN16-SO-000290 | PATCH | Windows Server 2016 must be configured to prevent anonymous users from having the same permissions as the Everyone group."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
      state: present
      value: EveryoneIncludesAnonymous
      data: 0
      datatype: dword
  when:
      - wn16_so_000290
  tags:
      - WN16-SO-000290
      - V-225047
      - SV-225047r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-SO-000320 | PATCH | Services using Local System that use Negotiate when reverting to NTLM authentication must use the computer identity instead of authenticating anonymously."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
      state: present
      value: UseMachineId
      data: 1
      datatype: dword
  when:
      - wn16_so_000320
  tags:
      - WN16-SO-000320
      - V-225049
      - SV-225049r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-SO-000330 | PATCH | NTLM must be prevented from falling back to a Null session."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0
      state: present
      value: allownullsessionfallback
      data: 0
      datatype: dword
  when:
      - wn16_so_000330
  tags:
      - WN16-SO-000330
      - V-225050
      - SV-225050r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-SO-000340 | PATCH | PKU2U authentication using online identities must be prevented."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\pku2u
      state: present
      value: AllowOnlineID
      data: 0
      datatype: dword
  when:
      - wn16_so_000340
  tags:
      - WN16-SO-000340
      - V-225051
      - SV-225051r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-SO-000350 | PATCH | Kerberos encryption types must be configured to prevent the use of DES and RC4 encryption suites."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Kerberos\Parameters
      state: present
      value: SupportedEncryptionTypes
      data: 2147483640
      datatype: dword
  when:
      - wn16_so_000350
  tags:
      - WN16-SO-000350
      - V-225052
      - SV-225052r569186_rule
      - SRG-OS-000120-GPOS-00061
      - CCI-000803
      - CAT2

- name: "MEDIUM | WN16-SO-000390 | PATCH | Windows Server 2016 must be configured to at least negotiate signing for LDAP client signing."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\LDAP
      state: present
      value: LDAPClientIntegrity
      data: 1
      datatype: dword
  when:
      - wn16_so_000390
  tags:
      - WN16-SO-000390
      - V-225055
      - SV-225055r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-SO-000400 | PATCH | Session security for NTLM SSP-based clients must be configured to require NTLMv2 session security and 128-bit encryption."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0
      state: present
      value: NTLMMinClientSec
      data: 537395200
      datatype: dword
  when:
      - wn16_so_000400
  tags:
      - WN16-SO-000400
      - V-225056
      - SV-225056r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-SO-000410 | PATCH | Session security for NTLM SSP-based servers must be configured to require NTLMv2 session security and 128-bit encryption."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0
      state: present
      value: NTLMMinServerSec
      data: 537395200
      datatype: dword
  when:
      - wn16_so_000410
  tags:
      - WN16-SO-000410
      - V-225057
      - SV-225057r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-SO-000420 | PATCH | Users must be required to enter a password to access private keys stored on the computer."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\Cryptography
      state: present
      value: ForceKeyProtection
      data: 2
      datatype: dword
  when:
      - wn16_so_000420
  tags:
      - WN16-SO-000420
      - V-225058
      - SV-225058r569186_rule
      - SRG-OS-000067-GPOS-00035
      - CCI-000186
      - CAT2

- name: "MEDIUM | WN16-SO-000430 | PATCH | Windows Server 2016 must be configured to use FIPS-compliant algorithms for encryption, hashing, and signing."
  ansible.windows.win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\FIPSAlgorithmPolicy
      state: present
      value: Enabled
      data: 1
      datatype: dword
  when:
      - wn16_so_000430
  tags:
      - WN16-SO-000430
      - V-225059
      - SV-225059r877398_rule
      - SRG-OS-000033-GPOS-00014
      - CCI-000068
      - CCI-002450
      - CAT2

- name: "MEDIUM | WN16-SO-000460 | PATCH | User Account Control approval mode for the built-in Administrator must be enabled."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      state: present
      value: FilterAdministratorToken
      data: 1
      datatype: dword
  when:
      - wn16_so_000460
      - not win_skip_for_test
  tags:
      - WN16-SO-000460
      - V-225061
      - SV-225061r852388_rule
      - SRG-OS-000373-GPOS-00157
      - CCI-002038
      - CAT2
      # - exclusions for server core? think its NA there

- name: "MEDIUM | WN16-SO-000470 | PATCH | UIAccess applications must not be allowed to prompt for elevation without using the secure desktop."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      state: present
      value: EnableUIADesktopToggle
      data: 0
      datatype: dword
  when:
      - wn16_so_000470
  tags:
      - WN16-SO-000470
      - V-225062
      - SV-225062r569186_rule
      - SRG-OS-000134-GPOS-00068
      - CCI-001084
      - CAT2

- name: "MEDIUM | WN16-SO-000480 | PATCH | User Account Control must, at a minimum, prompt administrators for consent on the secure desktop."
  block:
      - name: "MEDIUM | WN16-SO-000480 | AUDIT | User Account Control must, at a minimum, prompt administrators for consent on the secure desktop. | Variable Check."
        ansible.builtin.debug:
            msg:
                - "Warning!! You have have not choosen a correct setting for wn16stig_consentprompt"
                - "Please read the notes for the variable and make the necessary change to the variable to be in compliance."
        when:
            - wn16stig_consentprompt < 1 or
              wn16stig_consentprompt > 2

      - name: "MEDIUM | WN16-SO-000480 | AUDIT | User Account Control must, at a minimum, prompt administrators for consent on the secure desktop. | Warning Count."
        ansible.builtin.import_tasks: warning_facts.yml
        vars:
            warn_control_id: 'WN16-SO-000480'
        when:
            - wn16stig_consentprompt < 1 or
              wn16stig_consentprompt > 2

      - name: "MEDIUM | WN16-SO-000480 | PATCH | User Account Control must, at a minimum, prompt administrators for consent on the secure desktop. | Apply Variable."
        ansible.windows.win_regedit:
            path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
            state: present
            value: ConsentPromptBehaviorAdmin
            data: "{{ wn16stig_consentprompt }}"
            datatype: dword
        when:
            - wn16stig_consentprompt == 1 or
              wn16stig_consentprompt == 2
  when:
      - wn16_so_000480
  tags:
      - WN16-SO-000480
      - V-225063
      - SV-225063r569186_rule
      - SRG-OS-000134-GPOS-00068
      - CCI-001084
      - CAT2

- name: "MEDIUM | WN16-SO-000490 | PATCH | User Account Control must automatically deny standard user requests for elevation."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      state: present
      value: ConsentPromptBehaviorUser
      data: 0
      datatype: dword
  when:
      - wn16_so_000490
  tags:
      - WN16-SO-000490
      - V-225064
      - SV-225064r852389_rule
      - SRG-OS-000373-GPOS-00157
      - CCI-002038
      - CAT2

- name: "MEDIUM | WN16-SO-000500 | PATCH | User Account Control must be configured to detect application installations and prompt for elevation."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      state: present
      value: EnableInstallerDetection
      data: 1
      datatype: dword
  when:
      - wn16_so_000500
  tags:
      - WN16-SO-000500
      - V-225065
      - SV-225065r569186_rule
      - SRG-OS-000134-GPOS-00068
      - CCI-001084
      - CAT2

- name: "MEDIUM | WN16-SO-000510 | PATCH | User Account Control must only elevate UIAccess applications that are installed in secure locations."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      state: present
      value: EnableSecureUIAPaths
      data: 1
      datatype: dword
  when:
      - wn16_so_000510
  tags:
      - WN16-SO-000510
      - V-225066
      - SV-225066r569186_rule
      - SRG-OS-000134-GPOS-00068
      - CCI-001084
      - CAT2

- name: "MEDIUM | WN16-SO-000520 | PATCH | User Account Control must run all administrators in Admin Approval Mode, enabling UAC."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      state: present
      value: EnableLUA
      data: 1
      datatype: dword
  when:
      - wn16_so_000520
  tags:
      - WN16-SO-000520
      - V-225067
      - SV-225067r852390_rule
      - SRG-OS-000373-GPOS-00157
      - CCI-002038
      - CAT2

- name: "MEDIUM | WN16-SO-000530 | PATCH | User Account Control must virtualize file and registry write failures to per-user locations."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
      state: present
      value: EnableVirtualization
      data: 1
      datatype: dword
  when:
      - wn16_so_000530
  tags:
      - WN16-SO-000530
      - V-225068
      - SV-225068r569186_rule
      - SRG-OS-000134-GPOS-00068
      - CCI-001084
      - CAT2

- name: "MEDIUM | WN16-UC-000030 | PATCH | Zone information must be preserved when saving attachments."
  ansible.windows.win_regedit:
      path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Attachments
      state: present
      value: SaveZoneInformation
      data: 2
      datatype: dword
  when:
      - wn16_uc_000030
  tags:
      - WN16-UC-000030
      - V-225069
      - SV-225069r569186_rule
      - SRG-OS-000480-GPOS-00227
      - CCI-000366
      - CAT2

- name: "MEDIUM | WN16-UR-000010 | PATCH | The Access Credential Manager as a trusted caller user right must not be assigned to any groups or accounts."
  community.windows.win_security_policy:
      section: Privilege Rights
      key: SeTrustedCredManAccessPrivilege
      value: ""
  when:
      - wn16_ur_000010
  tags:
      - WN16-UR-000010
      - V-225070
      - SV-225070r877392_rule
      - SRG-OS-000324-GPOS-00125
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN16-UR-000050 | PATCH | The Allow log on locally user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeInteractiveLogonRight
      users: "{{ wn16stig_seinteractivelogonright }}"
      action: set
  when:
      - wn16_ur_000050
  tags:
      - WN16-UR-000050
      - V-225072
      - SV-225072r569186_rule
      - SRG-OS-000080-GPOS-00048
      - CCI-000213
      - CAT2

- name: "MEDIUM | WN16-UR-000070 | PATCH | The Back up files and directories user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeBackupPrivilege
      users: "{{ wn16stig_sebackuprivilege }}"
      action: set
  when:
      - wn16_ur_000070
  tags:
      - WN16-UR-000070
      - V-225073
      - SV-225073r877392_rule
      - SRG-OS-000324-GPOS-00125
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN16-UR-000080 | PATCH | The Create a pagefile user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeCreatePagefilePrivilege
      users: Administrators
      action: set
  when:
      - wn16_ur_000080
  tags:
      - WN16-UR-000080
      - V-225074
      - SV-225074r877392_rule
      - SRG-OS-000324-GPOS-00125
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN16-UR-000100 | PATCH | The Create global objects user right must only be assigned to Administrators, Service, Local Service, and Network Service."
  ansible.windows.win_user_right:
      name: SeCreateGlobalPrivilege
      users: "{{ wn16stig_secreateglobalprivilege }}"
      action: set
  when:
      - wn16_ur_000100
  tags:
      - WN16-UR-000100
      - V-225076
      - SV-225076r877392_rule
      - SRG-OS-000324-GPOS-00125
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN16-UR-000110 | PATCH | The Create permanent shared objects user right must not be assigned to any groups or accounts."
  community.windows.win_security_policy:
      section: Privilege Rights
      key: SeCreatePermanentPrivilege
      value: ""
  when:
      - wn16_ur_000110
  tags:
      - WN16-UR-000110
      - V-225077
      - SV-225077r877392_rule
      - SRG-OS-000324-GPOS-00125
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN16-UR-000120 | PATCH | The Create symbolic links user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeCreateSymbolicLinkPrivilege
      users: Administrators
      action: set
  when:
      - wn16_ur_000120
  tags:
      - WN16-UR-000120
      - V-225078
      - SV-225078r877392_rule
      - SRG-OS-000324-GPOS-00125
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN16-UR-000200 | PATCH | The Force shutdown from a remote system user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeRemoteShutdownPrivilege
      users: Administrators
      action: set
  when:
      - wn16_ur_000200
  tags:
      - WN16-UR-000200
      - V-225080
      - SV-225080r877392_rule
      - SRG-OS-000324-GPOS-00125
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN16-UR-000210 | PATCH | The Generate security audits user right must only be assigned to Local Service and Network Service."
  ansible.windows.win_user_right:
      name: SeAuditPrivilege
      users: "{{ wn16stig_seauditprivilege }}"
      action: set
  when:
      - wn16_ur_000210
  tags:
      - WN16-UR-000210
      - V-225081
      - SV-225081r877392_rule
      - SRG-OS-000324-GPOS-00125
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN16-UR-000220 | PATCH | The Impersonate a client after authentication user right must only be assigned to Administrators, Service, Local Service, and Network Service."
  ansible.windows.win_user_right:
      name: SeImpersonatePrivilege
      users: "{{ wn16stig_seimpersonateprivilege }}"
      action: set
  when:
      - wn16_ur_000220
  tags:
      - WN16-UR-000220
      - V-225082
      - SV-225082r877392_rule
      - SRG-OS-000324-GPOS-00125
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN16-UR-000230 | PATCH | The Increase scheduling priority user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeIncreaseBasePriorityPrivilege
      users: "{{ wn16stig_seincreasebasepriorityprivilege }}"
      action: set
  when:
      - wn16_ur_000230
  tags:
      - WN16-UR-000230
      - V-225083
      - SV-225083r877392_rule
      - SRG-OS-000324-GPOS-00125
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN16-UR-000240 | PATCH | The Load and unload device drivers user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeLoadDriverPrivilege
      users: Administrators
      action: set
  when:
      - wn16_ur_000240
  tags:
      - WN16-UR-000240
      - V-225084
      - SV-225084r877392_rule
      - SRG-OS-000324-GPOS-00125
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN16-UR-000250 | PATCH | The Lock pages in memory user right must not be assigned to any groups or accounts."
  community.windows.win_security_policy:
      section: Privilege Rights
      key: SeLockMemoryPrivilege
      value: "{{ wn16stig_selockmemorprivilege }}"
  when:
      - wn16_ur_000250
  tags:
      - WN16-UR-000250
      - V-225085
      - SV-225085r877392_rule
      - SRG-OS-000324-GPOS-00125
      - CCI-002235
      - CAT2
# Get-Content C:\secpol.cfg | where { $_ -like "SeLockMemoryPrivilege*" } can be used in possible audit work.
# This Will work for other user rights as well.  Need to convert SID to actual name or groups though.

- name: "MEDIUM | WN16-UR-000260 | PATCH | The Manage auditing and security log user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeSecurityPrivilege
      users: "{{ wn16stig_sesecurityprivilege }}"
      action: set
  when:
      - wn16_ur_000260
  tags:
      - WN16-UR-000260
      - V-225086
      - SV-225086r852405_rule
      - SRG-OS-000057-GPOS-00027
      - CCI-000162
      - CCI-000163
      - CCI-000164
      - CCI-000171
      - CCI-001914
      - CAT2

- name: "MEDIUM | WN16-UR-000270 | PATCH | The Modify firmware environment values user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeSystemEnvironmentPrivilege
      users: Administrators
      action: set
  when:
      - wn16_ur_000270
  tags:
      - WN16-UR-000270
      - V-225087
      - SV-225087r877392_rule
      - SRG-OS-000324-GPOS-00125
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN16-UR-000280 | PATCH | The Perform volume maintenance tasks user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeManageVolumePrivilege
      users: "{{ wn16stig_semanagevolumeprivilege }}"
      action: set
  when:
      - wn16_ur_000280
  tags:
      - WN16-UR-000280
      - V-225088
      - SV-225088r891712_rule
      - SRG-OS-000324-GPOS-00125
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN16-UR-000290 | PATCH | The Profile single process user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeProfileSingleProcessPrivilege
      users: Administrators
      action: set
  when:
      - wn16_ur_000290
  tags:
      - WN16-UR-000290
      - V-225089
      - SV-225089r877392_rule
      - SRG-OS-000324-GPOS-00125
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN16-UR-000300 | PATCH | The Restore files and directories user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeRestorePrivilege
      users: "{{ wn16stig_serestoreprivilege }}"
      action: set
  when:
      - wn16_ur_000300
  tags:
      - WN16-UR-000300
      - V-225092
      - SV-225092r877392_rule
      - SRG-OS-000324-GPOS-00125
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN16-UR-000310 | PATCH | The Take ownership of files or other objects user right must only be assigned to the Administrators group."
  ansible.windows.win_user_right:
      name: SeTakeOwnershipPrivilege
      users: "{{ wn16stig_setakeownershipprivilege }}"
      action: set
  when:
      - wn16_ur_000310
  tags:
      - WN16-UR-000310
      - V-225093
      - SV-225093r877392_rule
      - SRG-OS-000324-GPOS-00125
      - CCI-002235
      - CAT2

- name: "MEDIUM | WN16-CC-000421 | PATCH | The Windows Explorer Preview pane must be disabled for Windows Server 2016."
  block:
      - name: "MEDIUM | WN16-CC-000421 | PATCH | The Windows Explorer Preview pane must be disabled for Windows Server 2016. | NoPreviewPane Fix."
        ansible.windows.win_regedit:
            path: HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer
            state: present
            value: NoPreviewPane
            data: 1
            datatype: dword

      - name: "MEDIUM | WN16-CC-000421 | PATCH | The Windows Explorer Preview pane must be disabled for Windows Server 2016. | NoReadingPane Fix."
        ansible.windows.win_regedit:
            path: HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer
            state: present
            value: NoReadingPane
            data: 1
            datatype: dword
  when:
      - wn16_cc_000421
  tags:
      - WN16-CC-000421
      - V-236000
      - SV-236000r641817_rule
      - SRG-OS-000095-GPOS-00049
      - CCI-000366
      - CAT2
